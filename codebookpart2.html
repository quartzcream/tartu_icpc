<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">

<html>
  <head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <style>
      @prince-pdf { prince-pdf-page-layout: three-column-right }
      @page {
        size: 297mm 210mm;/*A4 -30mm*/
        margin: 19mm 15mm 10mm 10mm;
        /*@bottom-right { content: counter(page) }
        @right-top { content: flow(header) }*/
      }
      @font-face {
        font-family: Inconsolata;
        font-style: normal;
        font-weight: normal;
        src: url("https://www.levien.com/type/myfonts/inconsolata/InconsolataGo-Regular.ttf") format("truetype");
      }
      @font-face {
        font-family: Inconsolata;
        font-style: normal;
        font-weight: bold;
        src: url("https://www.levien.com/type/myfonts/inconsolata/InconsolataGo-Bold.ttf") format("truetype");
      }

      @font-face {
        font-family: 'm_1m';
        font-style: normal;
        font-weight: normal;
        src: url('http://mplus-fonts.osdn.jp/webfonts/basic_latin/mplus-1m-regular-sub.ttf') format("truetype");
      }

      @font-face {
        font-family: 'm_1m';
        font-style: normal;
        font-weight: bold;
        src: url('http://mplus-fonts.osdn.jp/webfonts/basic_latin/mplus-1m-medium-sub.ttf') format("truetype");
      }


      Pre,code{
        font-family: Inconsolata, prince-no-fallback;
      }

      .highlight {
        padding-top: 0px;
        columns: 3;
        column-rule: 0.2pt solid black;
        column-gap: 1pt;
        font: 9pt Inconsolata;
      }

      .highlight header {
        text-align: center;
        padding-top: 0px;
        padding-bottom: 0px;
        font: 10pt Inconsolata;
        line-height: 90%;  
        white-space: pre-wrap;
      }


      td.linenos { background-color: #f0f0f0; padding-right: 0px; }
      span.lineno { background-color: #f0f0f0; padding: 0 0px 0 0px; }
      pre { line-height: 100%; }
      body .hll { background-color: #ffffcc }
      body  { background: #ffffff; }
      body .c { color: #008800; font-style: italic } /* Comment */
      body .err { border: 1px solid #FF0000 } /* Error */
      body .k { color: #AA22FF; font-weight: bold } /* Keyword */
      body .o { color: #666666 } /* Operator */
      body .-RegionGreen { background-color: #D8FFD8 } /* RegionGreen */
      body .-RegionPink { background-color: #FFD8FF } /* RegionPink */
      body .-RegionYellow { background-color: #FFFFD8 } /* RegionYellow */
      body .ch { color: #008800; font-style: italic } /* Comment.Hashbang */
      body .cm { color: #008800; font-style: italic } /* Comment.Multiline */
      body .cp { color: #008800 } /* Comment.Preproc */
      body .cpf { color: #008800; font-style: italic } /* Comment.PreprocFile */
      body .c1 { color: #008800; font-style: italic } /* Comment.Single */
      body .cs { color: #008800; font-weight: bold } /* Comment.Special */
      body .gd { color: #A00000 } /* Generic.Deleted */
      body .ge { font-style: italic } /* Generic.Emph */
      body .gr { color: #FF0000 } /* Generic.Error */
      body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
      body .gi { color: #00A000 } /* Generic.Inserted */
      body .go { color: #888888 } /* Generic.Output */
      body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
      body .gs { font-weight: bold } /* Generic.Strong */
      body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
      body .gt { color: #0044DD } /* Generic.Traceback */
      body .kc { color: #AA22FF; font-weight: bold } /* Keyword.Constant */
      body .kd { color: #AA22FF; font-weight: bold } /* Keyword.Declaration */
      body .kn { color: #AA22FF; font-weight: bold } /* Keyword.Namespace */
      body .kp { color: #AA22FF } /* Keyword.Pseudo */
      body .kr { color: #AA22FF; font-weight: bold } /* Keyword.Reserved */
      body .kt { color: #00BB00; font-weight: bold } /* Keyword.Type */
      body .m { color: #666666 } /* Literal.Number */
      body .s { color: #BB4444 } /* Literal.String */
      body .na { color: #BB4444 } /* Name.Attribute */
      body .nb { color: #AA22FF } /* Name.Builtin */
      body .nc { color: #0000FF } /* Name.Class */
      body .no { color: #880000 } /* Name.Constant */
      body .nd { color: #AA22FF } /* Name.Decorator */
      body .ni { color: #999999; font-weight: bold } /* Name.Entity */
      body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
      body .nf { color: #00A000 } /* Name.Function */
      body .nl { color: #A0A000 } /* Name.Label */
      body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
      body .nt { color: #008000; font-weight: bold } /* Name.Tag */
      body .nv { color: #B8860B } /* Name.Variable */
      body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
      body .w { color: #bbbbbb } /* Text.Whitespace */
      body .mb { color: #666666 } /* Literal.Number.Bin */
      body .mf { color: #666666 } /* Literal.Number.Float */
      body .mh { color: #666666 } /* Literal.Number.Hex */
      body .mi { color: #666666 } /* Literal.Number.Integer */
      body .mo { color: #666666 } /* Literal.Number.Oct */
      body .sa { color: #BB4444 } /* Literal.String.Affix */
      body .sb { color: #BB4444 } /* Literal.String.Backtick */
      body .sc { color: #BB4444 } /* Literal.String.Char */
      body .dl { color: #BB4444 } /* Literal.String.Delimiter */
      body .sd { color: #BB4444; font-style: italic } /* Literal.String.Doc */
      body .s2 { color: #BB4444 } /* Literal.String.Double */
      body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
      body .sh { color: #BB4444 } /* Literal.String.Heredoc */
      body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
      body .sx { color: #008000 } /* Literal.String.Other */
      body .sr { color: #BB6688 } /* Literal.String.Regex */
      body .s1 { color: #BB4444 } /* Literal.String.Single */
      body .ss { color: #B8860B } /* Literal.String.Symbol */
      body .bp { color: #AA22FF } /* Name.Builtin.Pseudo */
      body .fm { color: #00A000 } /* Name.Function.Magic */
      body .vc { color: #B8860B } /* Name.Variable.Class */
      body .vg { color: #B8860B } /* Name.Variable.Global */
      body .vi { color: #B8860B } /* Name.Variable.Instance */
      body .vm { color: #B8860B } /* Name.Variable.Magic */
      body .il { color: #666666 } /* Literal.Number.Integer.Long */

    </style>
  </head>
  <body>
    <h2></h2>
    <div class="highlight"><pre>





<header>
<b>Triangle centers</b>
</header>
<span></span><span class="k">const</span> <span class="kt">double</span> <span class="n">min_delta</span> <span class="o">=</span> <span class="mf">1e-13</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">double</span> <span class="n">coord_max</span> <span class="o">=</span> <span class="mf">1e6</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">complex</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">point</span><span class="p">;</span>
<span class="n">point</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">;</span> <span class="c1">// vertixes of the triangle</span>
<span class="kt">bool</span> <span class="nf">collinear</span><span class="p">()</span> <span class="p">{</span>                                   <span class="mi">0823</span>
  <span class="kt">double</span> <span class="n">min_diff</span> <span class="o">=</span>
    <span class="n">min</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">),</span> <span class="n">min</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">C</span><span class="p">),</span> <span class="n">abs</span><span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">)));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">min_diff</span> <span class="o">&lt;</span> <span class="n">coord_max</span> <span class="o">*</span> <span class="n">min_delta</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">point</span> <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="n">A</span><span class="p">);</span>                      <span class="mo">0033</span>
  <span class="kt">double</span> <span class="n">ang</span> <span class="o">=</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">abs</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">arg</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="o">-</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ang</span> <span class="o">&lt;</span> <span class="n">min_delta</span><span class="p">;</span>
  <span class="c1">// positive angle with the real line</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">3048</span>
<span class="n">point</span> <span class="nf">circum_center</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">collinear</span><span class="p">())</span> <span class="k">return</span> <span class="n">point</span><span class="p">(</span><span class="n">NAN</span><span class="p">,</span> <span class="n">NAN</span><span class="p">);</span>
  <span class="c1">// squared lengths of sides</span>
  <span class="kt">double</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">C</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">);</span>                           <span class="mi">6715</span>
  <span class="c1">// barycentric coordinates of the circumcenter</span>
  <span class="c1">// sin(2 * alpha) works also</span>
  <span class="kt">double</span> <span class="n">c_A</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">*</span> <span class="p">(</span><span class="n">b2</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">a2</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">c_B</span> <span class="o">=</span> <span class="n">b2</span> <span class="o">*</span> <span class="p">(</span><span class="n">a2</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">b2</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">c_C</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">*</span> <span class="p">(</span><span class="n">a2</span> <span class="o">+</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">c2</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">c_A</span> <span class="o">+</span> <span class="n">c_B</span> <span class="o">+</span> <span class="n">c_C</span><span class="p">;</span>
  <span class="n">c_A</span> <span class="o">/=</span> <span class="n">sum</span><span class="p">;</span>                                        <span class="mi">9407</span>
  <span class="n">c_B</span> <span class="o">/=</span> <span class="n">sum</span><span class="p">;</span>
  <span class="n">c_C</span> <span class="o">/=</span> <span class="n">sum</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">c_A</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="n">c_B</span> <span class="o">*</span> <span class="n">B</span> <span class="o">+</span> <span class="n">c_C</span> <span class="o">*</span> <span class="n">C</span><span class="p">;</span> <span class="c1">// cartesian</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">6958</span>
<span class="n">point</span> <span class="nf">centroid</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// center of mass</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">point</span> <span class="nf">ortho_center</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// euler line</span>
  <span class="n">point</span> <span class="n">O</span> <span class="o">=</span> <span class="n">circum_center</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">O</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">centroid</span><span class="p">()</span> <span class="o">-</span> <span class="n">O</span><span class="p">);</span>                 <span class="mi">6051</span>
<span class="p">};</span>
<span class="n">point</span> <span class="nf">nine_point_circle_center</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// euler line</span>
  <span class="n">point</span> <span class="n">O</span> <span class="o">=</span> <span class="n">circum_center</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">O</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">centroid</span><span class="p">()</span> <span class="o">-</span> <span class="n">O</span><span class="p">);</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">8193</span>
<span class="n">point</span> <span class="nf">in_center</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">collinear</span><span class="p">())</span> <span class="k">return</span> <span class="n">point</span><span class="p">(</span><span class="n">NAN</span><span class="p">,</span> <span class="n">NAN</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">C</span><span class="p">);</span> <span class="c1">// side lenghts</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">C</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">c</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">);</span>                             <span class="mi">5954</span>
  <span class="c1">// trilinear coordinates are (1,1,1)</span>
  <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">/=</span> <span class="n">sum</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">/=</span> <span class="n">sum</span><span class="p">;</span>
  <span class="n">c</span> <span class="o">/=</span> <span class="n">sum</span><span class="p">;</span>                     <span class="c1">// barycentric</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">B</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">C</span><span class="p">;</span> <span class="c1">// cartesian</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">9596</span>
<header>
<b>Seg-Seg intersection, halfplane intersection area</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Seg</span> <span class="p">{</span>
  <span class="n">Vec</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">Vec</span> <span class="nf">d</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">Vec</span> <span class="nf">intersection</span><span class="p">(</span><span class="n">Seg</span> <span class="n">l</span><span class="p">,</span> <span class="n">Seg</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Vec</span> <span class="n">dl</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="p">(),</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">d</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="n">nanl</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">nanl</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)};</span>
  <span class="kt">double</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">len</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">dh</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">dl</span><span class="p">)</span> <span class="o">/</span> <span class="n">len</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>               <span class="mi">3280</span>
  <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">dl</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="o">-</span><span class="n">dh</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Returns the area bounded by halfplanes</span>
<span class="kt">double</span> <span class="n">calc_area</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;&amp;</span> <span class="n">lines</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">lb</span> <span class="o">=</span> <span class="o">-</span><span class="n">HUGE_VAL</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">HUGE_VAL</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;</span> <span class="n">slines</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>                             <span class="mi">9425</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">line</span> <span class="p">:</span> <span class="n">lines</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">line</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">line</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>                      <span class="mi">6288</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">line</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">slines</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">slines</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">({</span><span class="n">line</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">a</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>                                     <span class="mi">4028</span>
    <span class="n">sort</span><span class="p">(</span><span class="n">slines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span> <span class="n">slines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">(),</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Seg</span> <span class="n">l</span><span class="p">,</span> <span class="n">Seg</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="p">(),</span> <span class="n">r</span><span class="p">.</span><span class="n">d</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">normal</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="p">())</span> <span class="o">*</span> <span class="n">l</span><span class="p">.</span><span class="n">a</span> <span class="o">&gt;</span>               <span class="mi">6523</span>
                 <span class="n">normal</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">d</span><span class="p">())</span> <span class="o">*</span> <span class="n">r</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">cross</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">d</span><span class="p">(),</span> <span class="n">r</span><span class="p">.</span><span class="n">d</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">}</span>
  <span class="c1">// Now find the application area of the lines and clean</span>
  <span class="c1">// up redundant ones</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">ap_s</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span> <span class="n">apply</span> <span class="o">=</span> <span class="n">ap_s</span><span class="p">[</span><span class="n">side</span><span class="p">];</span>              <span class="mi">5622</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;</span> <span class="n">clines</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">line</span> <span class="p">:</span> <span class="n">slines</span><span class="p">[</span><span class="n">side</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">clines</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Seg</span> <span class="n">other</span> <span class="o">=</span> <span class="n">clines</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">d</span><span class="p">(),</span> <span class="n">other</span><span class="p">.</span><span class="n">d</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">double</span> <span class="n">start</span> <span class="o">=</span> <span class="n">intersection</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">other</span><span class="p">).</span><span class="n">y</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">apply</span><span class="p">.</span><span class="n">back</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>           <span class="mi">5287</span>
        <span class="p">}</span>
        <span class="n">clines</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
        <span class="n">apply</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">clines</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">apply</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">-</span><span class="n">HUGE_VAL</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">apply</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>                             <span class="mi">9835</span>
          <span class="n">intersection</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">clines</span><span class="p">.</span><span class="n">back</span><span class="p">()).</span><span class="n">y</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">clines</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">slines</span><span class="p">[</span><span class="n">side</span><span class="p">]</span> <span class="o">=</span> <span class="n">clines</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">ap_s</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">HUGE_VALL</span><span class="p">);</span>                      <span class="mi">8994</span>
  <span class="n">ap_s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">HUGE_VALL</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">{</span>
    <span class="kt">double</span> <span class="n">lb</span> <span class="o">=</span> <span class="o">-</span><span class="n">HUGE_VALL</span><span class="p">,</span> <span class="n">ub</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">slines</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                           <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">slines</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
         <span class="n">lb</span> <span class="o">=</span> <span class="n">ub</span><span class="p">)</span> <span class="p">{</span>                                  <span class="mi">4531</span>
      <span class="n">ub</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ap_s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ap_s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
      <span class="kt">double</span> <span class="n">alb</span> <span class="o">=</span> <span class="n">lb</span><span class="p">,</span> <span class="n">aub</span> <span class="o">=</span> <span class="n">ub</span><span class="p">;</span>
      <span class="n">Seg</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">slines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">slines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]};</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">(),</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>           <span class="mi">5904</span>
        <span class="n">alb</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">alb</span><span class="p">,</span> <span class="n">intersection</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="n">y</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">(),</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">aub</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">aub</span><span class="p">,</span> <span class="n">intersection</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="n">y</span><span class="p">);</span>
      <span class="p">}</span>                                              <span class="mi">9883</span>
      <span class="n">alb</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">alb</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
      <span class="n">aub</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">aub</span><span class="p">,</span> <span class="n">ub</span><span class="p">);</span>
      <span class="n">aub</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">aub</span><span class="p">,</span> <span class="n">alb</span><span class="p">);</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">alb</span> <span class="o">-</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span>
                                 <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">().</span><span class="n">y</span> <span class="o">*</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">().</span><span class="n">x</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">aub</span> <span class="o">-</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span>
                                 <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">().</span><span class="n">y</span> <span class="o">*</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">().</span><span class="n">x</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">+=</span>                                    <span class="mi">8864</span>
          <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aub</span> <span class="o">-</span> <span class="n">alb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ap_s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ap_s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">j</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">3672</span>
<header>
<b>Convex polygon algorithms</b>
</header>
<span></span><span class="k">typedef</span> <span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">Vec</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">Vec</span><span class="p">,</span> <span class="n">Vec</span><span class="o">&gt;</span> <span class="n">Seg</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">SegIt</span><span class="p">;</span>
<span class="cp">#define F first</span>
<span class="cp">#define S second</span>                                     <span class="mi">2608</span>
<span class="cp">#define MP(x, y) make_pair(x, y)</span>
<span class="n">Vec</span> <span class="nf">sub</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">MP</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">v2</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">v1</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">v2</span><span class="p">.</span><span class="n">S</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">ll</span> <span class="nf">dot</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>               <span class="mi">0940</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">v1</span><span class="p">.</span><span class="n">F</span> <span class="o">*</span> <span class="n">v2</span><span class="p">.</span><span class="n">F</span> <span class="o">+</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">v1</span><span class="p">.</span><span class="n">S</span> <span class="o">*</span> <span class="n">v2</span><span class="p">.</span><span class="n">S</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ll</span> <span class="n">cross</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">v1</span><span class="p">.</span><span class="n">F</span> <span class="o">*</span> <span class="n">v2</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">v2</span><span class="p">.</span><span class="n">F</span> <span class="o">*</span> <span class="n">v1</span><span class="p">.</span><span class="n">S</span><span class="p">;</span>
<span class="p">}</span>                                                    <span class="mi">2634</span>
<span class="n">ll</span> <span class="nf">dist_sq</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)(</span><span class="n">p2</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">F</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">F</span><span class="p">)</span> <span class="o">+</span>
         <span class="p">(</span><span class="n">ll</span><span class="p">)(</span><span class="n">p2</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">S</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">S</span><span class="p">);</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">4155</span>
<span class="k">struct</span> <span class="n">Point</span><span class="p">;</span>
<span class="n">multiset</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">end_node</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Point</span> <span class="p">{</span>
  <span class="n">Vec</span> <span class="n">p</span><span class="p">;</span>
  <span class="k">typename</span> <span class="n">multiset</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">get_it</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">gcc</span> <span class="n">rb_tree</span> <span class="n">dependent</span>                         <span class="mi">1510</span>
    <span class="n">tuple</span><span class="o">&lt;</span><span class="kt">void</span> <span class="o">*&gt;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span> <span class="o">-</span> <span class="mi">32</span><span class="p">};</span>
    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">multiset</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Point</span> <span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>           <span class="mi">6790</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">);</span> <span class="c1">// sort by x</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">nxt</span> <span class="o">=</span> <span class="n">next</span><span class="p">(</span><span class="n">get_it</span><span class="p">());</span>     <span class="c1">// convex hull trick</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nxt</span> <span class="o">==</span> <span class="n">end_node</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// nxt == end()</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">.</span><span class="n">S</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">{</span><span class="n">q</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">})</span> <span class="o">&lt;</span>                  <span class="mi">2658</span>
           <span class="n">q</span><span class="p">.</span><span class="n">S</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="p">{</span><span class="n">q</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">part</span><span class="o">&gt;</span> <span class="c1">// 1 = upper, -1 = lower</span>
<span class="k">struct</span> <span class="nl">HullDynamic</span> <span class="p">:</span> <span class="k">public</span> <span class="n">multiset</span><span class="o">&lt;</span><span class="n">Point</span><span class="p">,</span> <span class="n">less</span><span class="o">&lt;&gt;</span> <span class="o">&gt;</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">bad</span><span class="p">(</span><span class="n">iterator</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>                             <span class="mi">7293</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">begin</span><span class="p">())</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="n">prev</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">z</span> <span class="o">=</span> <span class="n">next</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">==</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">S</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">S</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">part</span> <span class="o">*</span>                                    <span class="mi">5485</span>
             <span class="n">cross</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">),</span> <span class="n">sub</span><span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">))</span> <span class="o">&lt;=</span>
           <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">insert_point</span><span class="p">(</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// O(log(N))</span>
    <span class="k">auto</span> <span class="n">y</span> <span class="o">=</span> <span class="n">insert</span><span class="p">({{</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">}});</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bad</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>                                    <span class="mo">025</span><span class="mi">8</span>
      <span class="n">erase</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">next</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">bad</span><span class="p">(</span><span class="n">next</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
      <span class="n">erase</span><span class="p">(</span><span class="n">next</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">begin</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">bad</span><span class="p">(</span><span class="n">prev</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> <span class="n">erase</span><span class="p">(</span><span class="n">prev</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>
  <span class="p">}</span>                                                  <span class="mi">9920</span>
  <span class="n">ll</span> <span class="nf">eval</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// O(log(N)) upper maximize dot({x, 1}, v)</span>
    <span class="n">end_node</span> <span class="o">=</span>
      <span class="n">end</span><span class="p">();</span> <span class="c1">//       lower minimize dot({x, 1}, v)</span>
    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">((</span><span class="n">Vec</span><span class="p">){</span><span class="n">x</span><span class="p">,</span> <span class="n">part</span><span class="p">});</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">S</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">8709</span>
<span class="k">struct</span> <span class="n">Hull</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;</span> <span class="n">hull</span><span class="p">;</span>
  <span class="n">SegIt</span> <span class="n">up_beg</span><span class="p">;</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">extend</span><span class="p">(</span><span class="n">It</span> <span class="n">beg</span><span class="p">,</span> <span class="n">It</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// O(n)</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&gt;</span> <span class="n">r</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">beg</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>           <span class="mi">9981</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="o">*</span><span class="n">it</span> <span class="o">!=</span> <span class="n">r</span><span class="p">.</span><span class="n">back</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
          <span class="n">Vec</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">F</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">F</span><span class="p">,</span>
            <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">S</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">S</span><span class="p">};</span>                <span class="mi">1365</span>
          <span class="n">Vec</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">it</span><span class="o">-&gt;</span><span class="n">F</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">F</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">S</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">S</span><span class="p">};</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="n">r</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">r</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">r</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>                     <span class="mi">8095</span>
      <span class="n">hull</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">Hull</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">vert</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// atleast 2 distinct points</span>
    <span class="n">sort</span><span class="p">(</span><span class="n">vert</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">vert</span><span class="p">.</span><span class="n">end</span><span class="p">());</span> <span class="c1">// O(n log(n))</span>
    <span class="n">extend</span><span class="p">(</span><span class="n">vert</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">vert</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>                <span class="mi">6560</span>
    <span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="n">extend</span><span class="p">(</span><span class="n">vert</span><span class="p">.</span><span class="n">rbegin</span><span class="p">(),</span> <span class="n">vert</span><span class="p">.</span><span class="n">rend</span><span class="p">());</span>
    <span class="n">up_beg</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">diff</span><span class="p">;</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">0939</span>
  <span class="kt">bool</span> <span class="nf">contains</span><span class="p">(</span><span class="n">Vec</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// O(log(n))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">hull</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">F</span> <span class="o">||</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">up_beg</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">it_low</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">up_beg</span><span class="p">,</span>
        <span class="n">MP</span><span class="p">(</span><span class="n">MP</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mf">2e9</span><span class="p">),</span> <span class="n">MP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>           <span class="mi">1542</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it_low</span> <span class="o">!=</span> <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="o">--</span><span class="n">it_low</span><span class="p">;</span>
      <span class="n">Vec</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="n">it_low</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">it_low</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span>
        <span class="n">it_low</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">it_low</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
      <span class="n">Vec</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">it_low</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">it_low</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span>                              <span class="mi">1144</span>
          <span class="mi">0</span><span class="p">)</span> <span class="c1">// &lt; 0 is inclusive, &lt;=0 is exclusive</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">{</span>
      <span class="k">auto</span> <span class="n">it_up</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">hull</span><span class="p">.</span><span class="n">rbegin</span><span class="p">(),</span>
        <span class="n">hull</span><span class="p">.</span><span class="n">rbegin</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">up_beg</span><span class="p">),</span>
        <span class="n">MP</span><span class="p">(</span><span class="n">MP</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mf">2e9</span><span class="p">),</span> <span class="n">MP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>            <span class="mi">9423</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it_up</span> <span class="o">-</span> <span class="n">hull</span><span class="p">.</span><span class="n">rbegin</span><span class="p">()</span> <span class="o">==</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">up_beg</span><span class="p">)</span>
        <span class="o">--</span><span class="n">it_up</span><span class="p">;</span>
      <span class="n">Vec</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="n">it_up</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">it_up</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">F</span><span class="p">,</span>
        <span class="n">it_up</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">it_up</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>                    <span class="mo">01</span><span class="mi">93</span>
      <span class="n">Vec</span> <span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">it_up</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">it_up</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span>
          <span class="mi">0</span><span class="p">)</span> <span class="c1">// &gt; 0 is inclusive, &gt;=0 is exclusive</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">3267</span>
  <span class="c1">// The function can have only one local min and max</span>
  <span class="c1">// and may be constant only at min and max.</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
  <span class="n">SegIt</span> <span class="n">max</span><span class="p">(</span><span class="n">function</span><span class="o">&lt;</span><span class="n">T</span><span class="p">(</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// O(log(n))</span>
    <span class="k">auto</span> <span class="n">l</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
    <span class="n">SegIt</span> <span class="n">b</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>                            <span class="mi">8566</span>
    <span class="n">T</span> <span class="n">b_v</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">m</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">T</span> <span class="n">l_v</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">l</span><span class="p">);</span>
      <span class="n">T</span> <span class="n">l_n_v</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
      <span class="n">T</span> <span class="n">m_v</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">);</span>
      <span class="n">T</span> <span class="n">m_n_v</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">||</span> <span class="n">l_v</span> <span class="o">&gt;</span> <span class="n">b_v</span><span class="p">)</span> <span class="p">{</span>            <span class="mi">3580</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span> <span class="c1">// If max is at l we may remove it from</span>
               <span class="c1">// the range.</span>
        <span class="n">b_v</span> <span class="o">=</span> <span class="n">l_v</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">l_n_v</span> <span class="o">&gt;</span> <span class="n">l_v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_v</span> <span class="o">&lt;</span> <span class="n">l_v</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">m_n_v</span> <span class="o">&gt;</span> <span class="n">m_v</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_v</span> <span class="o">&lt;</span> <span class="n">l_v</span><span class="p">)</span> <span class="p">{</span>                             <span class="mi">7715</span>
          <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">m_n_v</span> <span class="o">&gt;</span> <span class="n">m_v</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">T</span> <span class="n">l_v</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">l</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">||</span> <span class="n">l_v</span> <span class="o">&gt;</span> <span class="n">b_v</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
      <span class="n">b_v</span> <span class="o">=</span> <span class="n">l_v</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>                                 <span class="mi">2147</span>
      <span class="n">T</span> <span class="n">l_n_v</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">||</span> <span class="n">l_n_v</span> <span class="o">&gt;</span> <span class="n">b_v</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">b_v</span> <span class="o">=</span> <span class="n">l_n_v</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">5939</span>
  <span class="n">SegIt</span> <span class="nf">closest</span><span class="p">(</span>
    <span class="n">Vec</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// p can&#39;t be internal(can be on border),</span>
             <span class="c1">// hull must have atleast 3 points</span>
    <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">ref_p</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">front</span><span class="p">();</span> <span class="c1">// O(log(n))</span>
    <span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">(</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ref_p</span><span class="p">](</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="n">seg</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// accuracy of used type</span>
                               <span class="c1">// should be coord^-2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">)</span> <span class="k">return</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">M_PI</span><span class="p">;</span>            <span class="mo">0134</span>
        <span class="n">Vec</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span><span class="n">seg</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">seg</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
        <span class="n">Vec</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
        <span class="n">ll</span> <span class="n">c_p</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c_p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// order the backside by angle</span>
          <span class="n">Vec</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span><span class="n">ref_p</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ref_p</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
          <span class="n">Vec</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">{</span><span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
          <span class="n">ll</span> <span class="n">d_p</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>                      <span class="mi">5063</span>
          <span class="n">ll</span> <span class="n">c_p</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
          <span class="k">return</span> <span class="nf">atan2</span><span class="p">(</span><span class="n">c_p</span><span class="p">,</span> <span class="n">d_p</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ll</span> <span class="n">d_p</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">res</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">d_p</span><span class="p">,</span> <span class="n">c_p</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d_p</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">M_PI</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                               <span class="mi">5050</span>
          <span class="n">res</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">res</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">res</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
      <span class="p">}));</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">5632</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">DIRECTION</span><span class="o">&gt;</span> <span class="c1">// 1 or -1</span>
  <span class="n">Vec</span> <span class="n">tan_point</span><span class="p">(</span>
    <span class="n">Vec</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// can&#39;t be internal or on border</span>
    <span class="c1">//-1 iff CCW rotation of ray from p to res takes it</span>
    <span class="c1">// away from</span>
    <span class="c1">// polygon?</span>
    <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">ref_p</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">front</span><span class="p">();</span> <span class="c1">// O(log(n))</span>
    <span class="k">auto</span> <span class="n">best_seg</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">(</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ref_p</span><span class="p">](</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="n">seg</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// accuracy of used type</span>
                               <span class="c1">// should be coord^-2</span>
        <span class="n">Vec</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span><span class="n">ref_p</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ref_p</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
        <span class="n">Vec</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">{</span><span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">p</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
        <span class="n">ll</span> <span class="n">d_p</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>                        <span class="mo">0212</span>
        <span class="n">ll</span> <span class="n">c_p</span> <span class="o">=</span> <span class="n">DIRECTION</span> <span class="o">*</span> <span class="n">cross</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">atan2</span><span class="p">(</span><span class="n">c_p</span><span class="p">,</span> <span class="n">d_p</span><span class="p">);</span> <span class="c1">// order by signed angle</span>
      <span class="p">}));</span>
    <span class="k">return</span> <span class="n">best_seg</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">;</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">5890</span>
  <span class="n">SegIt</span> <span class="nf">max_in_dir</span><span class="p">(</span>
    <span class="n">Vec</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// first is the ans. O(log(n))</span>
    <span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">function</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">(</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">v</span><span class="p">](</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="n">seg</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">seg</span><span class="p">.</span><span class="n">F</span><span class="p">);</span> <span class="p">}));</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">5805</span>
  <span class="n">pair</span><span class="o">&lt;</span><span class="n">SegIt</span><span class="p">,</span> <span class="n">SegIt</span><span class="o">&gt;</span> <span class="n">intersections</span><span class="p">(</span><span class="n">Seg</span> <span class="n">l</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// O(log(n))</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">l</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">l</span><span class="p">.</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">;</span>
    <span class="n">Vec</span> <span class="n">dir</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">};</span>
    <span class="k">auto</span> <span class="n">it_max</span> <span class="o">=</span> <span class="n">max_in_dir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>                   <span class="mi">4740</span>
    <span class="k">auto</span> <span class="n">it_min</span> <span class="o">=</span> <span class="n">max_in_dir</span><span class="p">(</span><span class="n">MP</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">));</span>
    <span class="n">ll</span> <span class="n">opt_val</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">l</span><span class="p">.</span><span class="n">F</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">it_max</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">opt_val</span> <span class="o">||</span>
        <span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">it_min</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">opt_val</span><span class="p">)</span>               <span class="mi">8921</span>
      <span class="k">return</span> <span class="nf">MP</span><span class="p">(</span><span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="n">SegIt</span> <span class="n">it_r1</span><span class="p">,</span> <span class="n">it_r2</span><span class="p">;</span>
    <span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">inc_c</span><span class="p">(</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">](</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">lft</span><span class="p">,</span> <span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">rgt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lft</span><span class="p">.</span><span class="n">F</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rgt</span><span class="p">.</span><span class="n">F</span><span class="p">);</span>
      <span class="p">});</span>                                            <span class="mi">1828</span>
    <span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">dec_c</span><span class="p">(</span>
      <span class="p">[</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">](</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">lft</span><span class="p">,</span> <span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">rgt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">lft</span><span class="p">.</span><span class="n">F</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">rgt</span><span class="p">.</span><span class="n">F</span><span class="p">);</span>
      <span class="p">});</span>                                            <span class="mi">1765</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">it_min</span> <span class="o">&lt;=</span> <span class="n">it_max</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">it_r1</span> <span class="o">=</span>
        <span class="n">upper_bound</span><span class="p">(</span><span class="n">it_min</span><span class="p">,</span> <span class="n">it_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">inc_c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">hull</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">F</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">opt_val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">it_r2</span> <span class="o">=</span> <span class="n">upper_bound</span><span class="p">(</span>                         <span class="mi">8531</span>
                  <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">it_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">dec_c</span><span class="p">)</span> <span class="o">-</span>
                <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">it_r2</span> <span class="o">=</span>
          <span class="n">upper_bound</span><span class="p">(</span><span class="n">it_max</span><span class="p">,</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">l</span><span class="p">,</span> <span class="n">dec_c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">it_r1</span> <span class="o">=</span>
        <span class="n">upper_bound</span><span class="p">(</span><span class="n">it_max</span><span class="p">,</span> <span class="n">it_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">dec_c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">hull</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">F</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">opt_val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">it_r2</span> <span class="o">=</span> <span class="n">upper_bound</span><span class="p">(</span>                         <span class="mi">1538</span>
                  <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">it_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">inc_c</span><span class="p">)</span> <span class="o">-</span>
                <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">it_r2</span> <span class="o">=</span>
          <span class="n">upper_bound</span><span class="p">(</span><span class="n">it_min</span><span class="p">,</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">l</span><span class="p">,</span> <span class="n">inc_c</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">MP</span><span class="p">(</span><span class="n">it_r1</span><span class="p">,</span> <span class="n">it_r2</span><span class="p">);</span>                         <span class="mi">2632</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">2632</span>
  <span class="n">Seg</span> <span class="nf">diameter</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// O(n)</span>
    <span class="n">Seg</span> <span class="n">res</span><span class="p">;</span>
    <span class="n">ll</span> <span class="n">dia_sq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">it1</span> <span class="o">=</span> <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">it2</span> <span class="o">=</span> <span class="n">up_beg</span><span class="p">;</span>
    <span class="n">Vec</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span><span class="n">hull</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">hull</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span>
      <span class="n">hull</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">hull</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>            <span class="mi">2168</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">it2</span> <span class="o">!=</span> <span class="n">hull</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">Vec</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">{(</span><span class="n">it2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="p">(</span><span class="n">it2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span>
        <span class="p">(</span><span class="n">it2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="p">(</span><span class="n">it2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>                  <span class="mi">4807</span>
      <span class="o">--</span><span class="n">it2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span>
      <span class="n">it2</span> <span class="o">!=</span> <span class="n">hull</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// check all antipodal pairs</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dist_sq</span><span class="p">(</span><span class="n">it1</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dia_sq</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">it1</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">};</span>
        <span class="n">dia_sq</span> <span class="o">=</span> <span class="n">dist_sq</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">S</span><span class="p">);</span>              <span class="mi">7128</span>
      <span class="p">}</span>
      <span class="n">Vec</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">it1</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">it1</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">it1</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">it1</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
      <span class="n">Vec</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">it2</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">F</span> <span class="o">-</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">.</span><span class="n">S</span> <span class="o">-</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">.</span><span class="n">S</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                      <span class="mi">9381</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dist_sq</span><span class="p">(</span><span class="n">it1</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dia_sq</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">it1</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">};</span>
          <span class="n">dia_sq</span> <span class="o">=</span> <span class="n">dist_sq</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">S</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dist_sq</span><span class="p">(</span><span class="n">it1</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dia_sq</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">it1</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">,</span> <span class="n">it2</span><span class="o">-&gt;</span><span class="n">S</span><span class="p">};</span>                    <span class="mi">8171</span>
          <span class="n">dia_sq</span> <span class="o">=</span> <span class="n">dist_sq</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">F</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">S</span><span class="p">);</span>
        <span class="p">}</span> <span class="c1">// report cross pairs at parallel lines.</span>
        <span class="o">++</span><span class="n">it1</span><span class="p">;</span>
        <span class="o">++</span><span class="n">it2</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">it1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">it2</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">1111</span>
<header>
<b>Delaunay triangulation O(nlogn)</b>
</header>
<span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">max_co</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Vec</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">oth</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">oth</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">)</span> <span class="p">{</span>                  <span class="mi">2500</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">oth</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Vec</span> <span class="k">operator</span><span class="o">-</span><span class="p">(</span><span class="k">const</span> <span class="n">Vec</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">x</span> <span class="o">-</span> <span class="n">oth</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">oth</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="n">ll</span> <span class="nf">cross</span><span class="p">(</span><span class="n">Vec</span> <span class="n">a</span><span class="p">,</span> <span class="n">Vec</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">b</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>              <span class="mi">8725</span>
<span class="p">}</span>
<span class="n">ll</span> <span class="n">dot</span><span class="p">(</span><span class="n">Vec</span> <span class="n">a</span><span class="p">,</span> <span class="n">Vec</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">b</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="n">Edge</span> <span class="p">{</span>
  <span class="n">Vec</span> <span class="n">tar</span><span class="p">;</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">nxt</span><span class="p">;</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">inv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                                  <span class="mi">4335</span>
  <span class="kt">bool</span> <span class="n">vis</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">Seg</span> <span class="p">{</span>
  <span class="n">Vec</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">oth</span><span class="p">.</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">==</span> <span class="n">oth</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">)</span> <span class="p">{</span>                  <span class="mi">8977</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">oth</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="n">ll</span> <span class="nf">orient</span><span class="p">(</span><span class="n">Vec</span> <span class="n">a</span><span class="p">,</span> <span class="n">Vec</span> <span class="n">b</span><span class="p">,</span> <span class="n">Vec</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">c</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">b</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span>
         <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">c</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>                      <span class="mi">3775</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">3775</span>
<span class="kt">bool</span> <span class="nf">in_c_circle</span><span class="p">(</span><span class="n">Vec</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span> <span class="n">Vec</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cross</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// degenerate</span>
  <span class="n">ll</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>                                     <span class="mi">4264</span>
    <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="o">-</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">__int128</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//double seems to work as well</span>
  <span class="n">res</span> <span class="o">+=</span>                                             <span class="mi">5099</span>
    <span class="p">(</span><span class="n">__int128</span><span class="p">)(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
    <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">res</span> <span class="o">+=</span>
    <span class="p">(</span><span class="n">__int128</span><span class="p">)(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
    <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>                                         <span class="mi">6577</span>
  <span class="n">res</span> <span class="o">-=</span>
    <span class="p">(</span><span class="n">__int128</span><span class="p">)(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
    <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">1845</span>
<span class="n">Edge</span> <span class="o">*</span><span class="nf">add_triangle</span><span class="p">(</span><span class="n">Edge</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">Edge</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">Edge</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">old</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">};</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Edge</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rep</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>                           <span class="mi">8219</span>
    <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">,</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">inv</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">inv</span><span class="p">)</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">inv</span><span class="o">-&gt;</span><span class="n">inv</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">Edge</span> <span class="o">*</span><span class="n">add_point</span><span class="p">(</span>                                     <span class="mo">00</span><span class="mi">87</span>
  <span class="n">Vec</span> <span class="n">p</span><span class="p">,</span> <span class="n">Edge</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// returns outgoing edge</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">triangle</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">};</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">orient</span><span class="p">(</span><span class="n">triangle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">,</span>
          <span class="n">triangle</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>                                   <span class="mo">0233</span>
  <span class="p">}</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">triangle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Edge</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">triangle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span> <span class="c1">// unless we are on last layer we</span>
                    <span class="c1">// must exit here</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">Edge</span> <span class="n">p_as_e</span><span class="p">{</span><span class="n">p</span><span class="p">};</span>                                    <span class="mi">5490</span>
  <span class="n">Edge</span> <span class="n">tmp</span><span class="p">{</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">};</span>
  <span class="n">tmp</span><span class="p">.</span><span class="n">inv</span> <span class="o">=</span> <span class="n">add_triangle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_as_e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">);</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">inv</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">.</span><span class="n">tar</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">;</span>                                <span class="mi">4005</span>
  <span class="n">tmp</span><span class="p">.</span><span class="n">inv</span> <span class="o">=</span> <span class="n">add_triangle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_as_e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">);</span>
  <span class="n">tmp</span><span class="p">.</span><span class="n">tar</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">;</span>
  <span class="n">res</span><span class="o">-&gt;</span><span class="n">inv</span> <span class="o">=</span> <span class="n">add_triangle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_as_e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">);</span>
  <span class="n">res</span><span class="o">-&gt;</span><span class="n">inv</span><span class="o">-&gt;</span><span class="n">inv</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>                               <span class="mi">3259</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">Edge</span> <span class="o">*</span><span class="n">delaunay</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">random_shuffle</span><span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">points</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="n">Vec</span> <span class="n">arr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">4</span> <span class="o">*</span> <span class="n">max_co</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">max_co</span><span class="p">},</span>             <span class="mi">5591</span>
    <span class="p">{</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">max_co</span><span class="p">,</span> <span class="n">max_co</span><span class="p">},</span> <span class="p">{</span><span class="n">max_co</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">max_co</span><span class="p">}};</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Edge</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">res</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">Vec</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">points</span><span class="p">)</span> <span class="p">{</span>                          <span class="mi">4575</span>
    <span class="n">Edge</span> <span class="o">*</span><span class="n">loc</span> <span class="o">=</span> <span class="n">add_point</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="n">Edge</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">loc</span><span class="p">;</span>
    <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">;</span>
      <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">;</span>                        <span class="mi">1771</span>
      <span class="n">Edge</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">inv</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="n">in_c_circle</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">Edge</span> <span class="n">tmp</span><span class="p">{</span><span class="n">cur</span><span class="p">};</span>
        <span class="n">tmp</span><span class="p">.</span><span class="n">inv</span> <span class="o">=</span> <span class="n">add_triangle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">);</span>
        <span class="n">tmp</span><span class="p">.</span><span class="n">tar</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">;</span>                       <span class="mi">9851</span>
        <span class="n">tmp</span><span class="p">.</span><span class="n">inv</span><span class="o">-&gt;</span><span class="n">inv</span> <span class="o">=</span>
          <span class="n">add_triangle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">,</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">);</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">inv</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">inv</span><span class="p">;</span>                      <span class="mo">0151</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">tar</span> <span class="o">==</span> <span class="n">loc</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">9625</span>
<span class="kt">void</span> <span class="nf">extract_triangles</span><span class="p">(</span>
  <span class="n">Edge</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">vis</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">inc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">Edge</span> <span class="o">*</span><span class="n">it</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="n">it</span><span class="o">-&gt;</span><span class="n">vis</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>                                <span class="mi">9190</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">extract_triangles</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Edge</span> <span class="o">*</span><span class="n">triangle</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cur</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">};</span>
      <span class="n">res</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>                    <span class="mi">6207</span>
      <span class="n">vector</span><span class="o">&lt;</span><span class="n">Seg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">tar</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">abs</span><span class="p">(</span><span class="n">triangle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_co</span> <span class="o">&amp;&amp;</span>
              <span class="n">abs</span><span class="p">(</span><span class="n">triangle</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span>
                <span class="n">max_co</span><span class="p">))</span>                             <span class="mi">9617</span>
          <span class="n">tar</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">triangle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">,</span>
            <span class="n">triangle</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tar</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tar</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">res</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">8602</span>
<header>
<b>Contest setup</b>
</header>
<span></span><span class="nb">alias</span> g++<span class="o">=</span><span class="s1">&#39;g++ -g -Wall -Wshadow -Wconversion \  #.bashrc</span>
<span class="s1">    -fsanitize=undefined,address -DCDEBUG&#39;</span>       <span class="c1">#.bashrc</span>
<span class="nb">alias</span> <span class="nv">a</span><span class="o">=</span><span class="s1">&#39;setxkbmap us -option&#39;</span>                   <span class="c1">#.bashrc</span>
<span class="nb">alias</span> <span class="nv">m</span><span class="o">=</span><span class="s1">&#39;setxkbmap us -option caps:escape&#39;</span>       <span class="c1">#.bashrc</span>
<span class="nb">alias</span> <span class="nv">ma</span><span class="o">=</span><span class="s1">&#39;setxkbmap us -variant dvp \            #.bashrc</span>
<span class="s1">    -option caps:escape&#39;</span>                         <span class="c1">#.bashrc</span>
gsettings <span class="nb">set</span> org.compiz.core: <span class="se">\ </span>               <span class="c1">#settings</span>
    /org/compiz/profiles/Default/plugins/core/ hsize <span class="m">4</span>
gsettings <span class="nb">set</span> org.gnome.desktop.wm.preferences <span class="se">\</span>
    focus-mode <span class="s1">&#39;sloppy&#39;</span>                         <span class="c1">#settings</span>
gvim template.cpp
<span class="nb">cd</span> samps                                 <span class="c1">#copy everything</span>
<span class="k">for</span> d in *<span class="p">;</span> <span class="k">do</span> <span class="nb">cd</span> <span class="nv">$d</span><span class="p">;</span> <span class="k">for</span> f in *<span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
    cp <span class="nv">$f</span> <span class="s2">&quot;../../</span><span class="si">${</span><span class="nv">d</span><span class="p">,,</span><span class="si">}</span><span class="nv">$f</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="se">\</span>
    <span class="nb">cd</span> ..<span class="p">;</span> cp <span class="s2">&quot;../template.cpp&quot;</span> <span class="s2">&quot;../</span><span class="si">${</span><span class="nv">d</span><span class="p">,,</span><span class="si">}</span><span class="s2">.cpp&quot;</span><span class="p">;</span> <span class="k">done</span>
<span class="nb">cd</span> ..
<span class="nb">set</span> si cin                                        <span class="c1">#.vimrc</span>
<span class="nb">set</span> <span class="nv">ts</span><span class="o">=</span><span class="m">4</span> <span class="nv">sw</span><span class="o">=</span><span class="m">4</span> noet                                <span class="c1">#.vimrc</span>
<span class="nb">set</span> <span class="nv">cb</span><span class="o">=</span>unnamedplus                                <span class="c1">#.vimrc</span>
<span class="o">(</span>global-set-key <span class="o">(</span>kbd <span class="s2">&quot;C-x &lt;next&gt;&quot;</span><span class="o">)</span> <span class="s1">&#39;other-window) #.emacs</span>
<span class="s1">(global-set-key (kbd &quot;C-x &lt;prior&gt;&quot;) \             #.emacs</span>
<span class="s1">    &#39;</span>previous-multiframe-window<span class="o">)</span>                  <span class="c1">#.emacs</span>
<span class="o">(</span>global-set-key <span class="o">(</span>kbd <span class="s2">&quot;C-M-z&quot;</span><span class="o">)</span> <span class="err">&#39;</span>ansi-term<span class="o">)</span>         <span class="c1">#.emacs</span>
                                                  <span class="c1">#.emacs</span>
<span class="o">(</span>global-linum-mode <span class="m">1</span><span class="o">)</span>                             <span class="c1">#.emacs</span>
<span class="o">(</span>column-number-mode <span class="m">1</span><span class="o">)</span>                            <span class="c1">#.emacs</span>
<span class="o">(</span>show-paren-mode <span class="m">1</span><span class="o">)</span>                               <span class="c1">#.emacs</span>
<span class="o">(</span>setq-default indent-tabs-mode nil<span class="o">)</span>               <span class="c1">#.emacs</span>
valgrind --vgdb-error<span class="o">=</span><span class="m">0</span> ./a &lt;inp <span class="p">&amp;</span>              <span class="c1">#valgrind</span>
gdb a                                           <span class="c1">#valgrind</span>
target remote <span class="p">|</span> vgdb                            <span class="c1">#valgrind</span>
<header>
<b>crc.sh</b>
</header>
<span></span><span class="ch">#!/bin/envbash</span>
<span class="k">for</span> j in <span class="sb">`</span>seq <span class="nv">$2</span> <span class="m">1</span> <span class="nv">$3</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span> <span class="c1">#whistespaces don&#39;t matter.</span>
  sed <span class="s1">&#39;/^\s*$/d&#39;</span> <span class="nv">$1</span> <span class="p">|</span> head -<span class="nv">$j</span> <span class="p">|</span> tr -d <span class="s1">&#39;[[:space:]]&#39;</span> <span class="se">\</span>
    <span class="p">|</span> cksum <span class="p">|</span> cut -f1 -d <span class="s1">&#39; &#39;</span> <span class="p">|</span> tail -c <span class="m">5</span>
<span class="k">done</span> <span class="c1">#there shouldn&#39;t be any COMMENTS.</span>
<span class="c1">#copy lines being checked to separate file.</span>
<span class="c1"># $ ./crc.sh tmp.cpp 999 999</span>
<span class="c1"># $ ./crc.sh tmp.cpp 1 333 | grep XXXX</span>
<header>
<b>gcc ordered set, hashtable</b>
</header>
<span></span><span class="cp">#define DEBUG(...) cerr &lt;&lt; __VA_ARGS__ &lt;&lt; endl;</span>
<span class="cp">#ifndef CDEBUG</span>
<span class="cp">#undef DEBUG</span>
<span class="cp">#define DEBUG(...) ((void)0);</span>
<span class="cp">#define NDEBUG</span>                                       <span class="mi">4737</span>
<span class="cp">#endif</span>
<span class="cp">#define ran(i, a, b) for (auto i = (a); i &lt; (b); i++)</span>
<span class="cp">#include</span> <span class="cpf">&lt;bits/stdc++.h&gt;</span><span class="cp"></span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">double</span> <span class="n">ld</span><span class="p">;</span>                              <span class="mi">8529</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>                                <span class="o">%</span><span class="mi">8529</span>
<span class="cp">#pragma GCC optimize(&quot;Ofast&quot;) </span><span class="c1">// better vectorization</span>
<span class="cp">#pragma GCC target(&quot;avx,avx2&quot;)</span>
<span class="c1">// double vectorized performance</span>
<span class="cp">#include</span> <span class="cpf">&lt;bits/extc++.h&gt;</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">__gnu_pbds</span><span class="p">;</span>                          <span class="mi">2960</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">hashmap</span> <span class="o">=</span> <span class="n">gp_hash_table</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">// dumb, 3x faster than stl</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">ordered_set</span> <span class="o">=</span> <span class="n">tree</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">null_type</span><span class="p">,</span> <span class="n">less</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">rb_tree_tag</span><span class="p">,</span> <span class="n">tree_order_statistics_node_update</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">ordered_set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">cur</span><span class="p">;</span>
  <span class="n">cur</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">cur</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cur</span><span class="p">.</span><span class="n">order_of_key</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="c1">// the number of elements in the set less than 2</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">cur</span><span class="p">.</span><span class="n">find_by_order</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="c1">// the 1-st smallest number in the set(0-based)</span>
  <span class="n">ordered_set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">oth</span><span class="p">;</span>
  <span class="n">oth</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="c1">// to join: cur &lt; oth</span>
  <span class="n">cur</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">oth</span><span class="p">);</span> <span class="c1">// cur = {1, 3, 5}, oth = {}</span>
  <span class="n">cur</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">oth</span><span class="p">);</span> <span class="c1">// cur = {1}, oth = {3, 5}</span>
  <span class="n">hashmap</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">({},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">});</span>
<span class="p">}</span>
<header>
<b>PRNGs and Hash functions</b>
</header>
<span></span><span class="n">mt19937</span> <span class="n">gen</span><span class="p">;</span>
<span class="kt">uint64_t</span> <span class="nf">rand64</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">gen</span><span class="p">()</span> <span class="o">^</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">gen</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">5668</span>
<span class="kt">uint64_t</span> <span class="nf">rand64</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//x != 0</span>
  <span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mh">0x2545f4914f6cdd1d</span><span class="p">;</span> <span class="c1">// can remove mult</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">6873</span>
<span class="kt">uint64_t</span> <span class="nf">mix</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">){</span> <span class="c1">// deadbeef -&gt; y allowed</span>
<span class="n">variable</span> <span class="kt">uint64_t</span> <span class="n">mem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0xdeadbeeffeebdaedull</span> <span class="p">};</span>
        <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span>
                <span class="s">&quot;pxor %%xmm0, %%xmm0;&quot;</span>               <span class="mi">4939</span>
                <span class="s">&quot;movdqa (%0), %%xmm1;&quot;</span>
                <span class="s">&quot;aesenc %%xmm0, %%xmm1;&quot;</span>
                <span class="s">&quot;movdqa %%xmm1, (%0);&quot;</span>
                <span class="o">:</span>
                <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">:</span> <span class="s">&quot;memory&quot;</span>
        <span class="p">);</span>
        <span class="k">return</span> <span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// use both slots for 128 bit</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">7419</span>
<span class="kt">uint64_t</span> <span class="nf">mix64</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//x != 0</span>
  <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0xbf58476d1ce4e5b9</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x94d049bb133111eb</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>                                 <span class="mi">7317</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">8619</span>
<span class="kt">uint64_t</span> <span class="nf">unmix64</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">62</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x319642b2d24d8ec3</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">54</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x96de1b173f119089</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">60</span><span class="p">);</span>                     <span class="mi">5864</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">4224</span>
<span class="kt">uint64_t</span> <span class="nf">combine64</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="n">swap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span> <span class="c1">// remove for ord</span>
  <span class="k">return</span> <span class="n">mix64</span><span class="p">(</span><span class="n">mix64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">1550</span>
<header>
<b>Memorypool</b>
</header>
<span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">BLOCK</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">MEM_SIZE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">glob_buf</span><span class="p">[</span><span class="n">MEM_SIZE</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">glob_idx</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">glob_used</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">init_mem</span><span class="p">()</span> <span class="p">{</span>                                    <span class="mi">9423</span>
  <span class="n">glob_used</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">MEM_SIZE</span> <span class="o">/</span> <span class="n">BLOCK</span><span class="p">);</span>
  <span class="n">glob_used</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">Ptr</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
  <span class="k">explicit</span> <span class="nf">Ptr</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">tar</span><span class="p">)</span> <span class="p">{</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tar</span> <span class="o">-</span> <span class="n">glob_buf</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">Ptr</span><span class="p">()</span> <span class="p">{</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>                                 <span class="mi">1466</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">construct</span><span class="p">(</span><span class="n">Args</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="p">(</span><span class="n">glob_buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">)</span> <span class="n">T</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>                                     <span class="mi">1975</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="p">)(</span><span class="n">glob_buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">();</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">Ptr</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">oth</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>                           <span class="mi">7762</span>
  <span class="p">}</span>
  <span class="k">operator</span> <span class="kt">unsigned</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">idx</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">Ptr</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="kt">int</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">idx</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Ptr</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span>                          <span class="mi">4370</span>
    <span class="n">Ptr</span> <span class="n">res</span><span class="p">;</span>
    <span class="n">res</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+=</span> <span class="n">diff</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="o">&amp;</span><span class="k">operator</span><span class="p">[](</span><span class="kt">int</span> <span class="n">diff</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">diff</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>              <span class="mi">1487</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// TLE if running low on mem</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">glob_idx</span><span class="p">)</span> <span class="n">glob_idx</span> <span class="o">=</span> <span class="n">MEM_SIZE</span> <span class="o">/</span> <span class="n">BLOCK</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">glob_used</span><span class="p">[</span><span class="o">--</span><span class="n">glob_idx</span><span class="p">])</span> <span class="p">{</span>                     <span class="mi">9661</span>
      <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">len</span> <span class="o">+=</span> <span class="n">BLOCK</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">BLOCK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BLOCK</span><span class="p">)</span>
    <span class="n">glob_used</span><span class="p">[</span><span class="n">glob_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">;</span>                                        <span class="mi">8678</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="n">res</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">BLOCK</span> <span class="o">*</span> <span class="n">glob_idx</span><span class="p">;</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)(</span><span class="n">res</span> <span class="o">+</span> <span class="n">i</span><span class="p">).</span><span class="n">construct</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">dealloc</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>                    <span class="mi">2141</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">BLOCK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BLOCK</span><span class="p">)</span>
    <span class="n">glob_used</span><span class="p">[</span><span class="n">ptr</span><span class="p">.</span><span class="n">idx</span> <span class="o">/</span> <span class="n">BLOCK</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">hash</span><span class="o">&lt;</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="p">{</span>                               <span class="mi">3854</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">cur</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">3700</span>
<header>
<b>Radixsort 50M 64 bit integers as single array in 1 sec</b>
</header>
<span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">rsort</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">b_s</span><span class="p">[</span><span class="mi">256</span><span class="p">]{};</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="o">++</span><span class="n">b_s</span><span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">];</span> <span class="p">}</span>
  <span class="o">//</span> <span class="o">++</span><span class="n">b_s</span><span class="p">[</span><span class="o">*</span><span class="p">((</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)(</span><span class="n">a</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">)];</span>                 <span class="mi">1489</span>
  <span class="n">T</span> <span class="o">*</span><span class="n">mem</span><span class="p">[</span><span class="mi">257</span><span class="p">];</span>
  <span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">T</span> <span class="o">**</span><span class="n">l_b</span> <span class="o">=</span> <span class="n">mem</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">l_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span> <span class="n">l_b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">it</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>            <span class="mi">6813</span>
    <span class="n">T</span> <span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">l_b</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">l_b</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">T</span> <span class="o">*</span><span class="n">l_a</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="n">l_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="n">l_a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>                                 <span class="mi">4380</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">l_b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">l_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sort</span><span class="p">(</span><span class="n">l_b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">copy</span><span class="p">(</span><span class="n">l_b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_b</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">l_a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">rsort</span><span class="p">(</span><span class="n">l_b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b_s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>                                              <span class="mi">7759</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">3895</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">nmax</span> <span class="o">=</span> <span class="mf">5e7</span><span class="p">;</span>
<span class="n">ll</span> <span class="n">arr</span><span class="p">[</span><span class="n">nmax</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="n">nmax</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nmax</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ll</span><span class="p">)</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">rand</span><span class="p">();</span>
  <span class="n">rsort</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">nmax</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">is_sorted</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">nmax</span><span class="p">));</span>
<span class="p">}</span>
<header>
<b>FFT 10-15M length/sec</b>
</header>
<span></span><span class="c1">// integer c = a*b is accurate if c_i &lt; 2^49</span>
<span class="cp">#pragma GCC optimize (&quot;Ofast&quot;) </span><span class="c1">//10% performance</span>
<span class="cp">#include</span> <span class="cpf">&lt;complex.h&gt;</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">__complex__</span> <span class="kt">double</span> <span class="n">__muldc3</span><span class="p">(</span>
    <span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">,</span> <span class="kt">double</span> <span class="n">c</span><span class="p">,</span> <span class="kt">double</span> <span class="n">d</span><span class="p">){</span>
  <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="o">+</span><span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="p">);</span> <span class="c1">// 40% performance</span>
<span class="p">}</span>                                                    <span class="mi">6910</span>
<span class="cp">#include</span> <span class="cpf">&lt;bits/stdc++.h&gt;</span><span class="cp"></span>
<span class="k">typedef</span> <span class="n">complex</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Comp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">fft_rec</span><span class="p">(</span><span class="n">Comp</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span> <span class="n">Comp</span> <span class="o">*</span><span class="n">root_pow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>                                    <span class="mi">6092</span>
    <span class="n">fft_rec</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span>       <span class="n">root_pow</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">fft_rec</span><span class="p">(</span><span class="n">arr</span> <span class=" -RegionPink">+ len</span><span class="p">,</span> <span class="n">root_pow</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">root_pow</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">){</span>
    <span class="n">tie</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">len</span><span class="p">])</span> <span class="o">=</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">Comp</span><span class="p">,</span> <span class="n">Comp</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class=" -RegionPink">+</span> <span class="n">root_pow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">len</span><span class="p">],</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class=" -RegionPink">-</span> <span class="n">root_pow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">len</span><span class="p">]</span> <span class="p">};</span>
  <span class="p">}</span>                                                  <span class="mi">5001</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">fft</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Comp</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ord</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">arr</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">);</span>
  <span class="k">static</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Comp</span><span class="o">&gt;</span> <span class="n">root_pow</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>                   <span class="mi">4070</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">inc_pow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">is_inv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">inc_pow</span> <span class="o">&lt;=</span> <span class="n">ord</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">root_pow</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="n">root_pow</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">);</span>                       <span class="mi">0927</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">inc_pow</span> <span class="o">&lt;=</span> <span class="n">ord</span><span class="p">;</span> <span class="o">++</span><span class="n">inc_pow</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">idx_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx_p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ord</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
           <span class="n">idx_p</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ord</span> <span class="o">-</span> <span class="n">inc_pow</span><span class="p">),</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">root_pow</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">Comp</span> <span class="p">{</span>                       <span class="mi">0935</span>
           <span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">idx_p</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ord</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span>
           <span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">idx_p</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ord</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_inv</span><span class="p">)</span> <span class="n">root_pow</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">conj</span><span class="p">(</span><span class="n">root_pow</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
      <span class="p">}</span>                                              <span class="mi">5222</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">invert</span> <span class="o">!=</span> <span class="n">is_inv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">is_inv</span> <span class="o">=</span> <span class="n">invert</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Comp</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">root_pow</span><span class="p">)</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">conj</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ord</span><span class="p">)){</span>
    <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ord</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>                          <span class="mi">4150</span>
    <span class="kt">bool</span> <span class="n">cont</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cont</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">;</span>
      <span class="n">j</span> <span class="o">^=</span> <span class="n">m</span><span class="p">;</span>
      <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="n">swap</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">fft_rec</span><span class="p">(</span><span class="n">arr</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">root_pow</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ord</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>                                        <span class="mi">2958</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ord</span><span class="p">)</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">);</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">1362</span>
<span class="kt">void</span> <span class="nf">mult_poly_mod</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// c += a*b</span>
  <span class="k">static</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Comp</span><span class="o">&gt;</span> <span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="c1">// correct upto 0.5-2M elements(mod ~= 1e9)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>                              <span class="mi">5517</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">b</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
        <span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ll</span><span class="p">)</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="n">mod</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                           <span class="mo">015</span><span class="mi">8</span>
    <span class="kt">int</span> <span class="n">ord</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">__builtin_clz</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">){</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resize</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">);</span>
    <span class="p">}</span>                                                <span class="mi">7344</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
      <span class="n">fill</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">begin</span><span class="p">(),</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">(),</span> <span class="n">Comp</span><span class="p">{});</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">cur</span> <span class="o">+=</span> <span class="n">mod</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">cur</span> <span class="o">+=</span> <span class="n">mod</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>                            <span class="mi">7118</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">())){</span>
      <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
      <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>                    <span class="mi">3548</span>
    <span class="p">}</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">())){</span>
      <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Comp</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)};</span>
      <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Comp</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)};</span>
    <span class="p">}</span>                                                <span class="mi">2484</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="n">fft</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ord</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">tar</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">Comp</span> <span class="n">mult</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">^</span> <span class="n">j</span><span class="p">)</span> <span class="n">mult</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>                 <span class="mi">6876</span>
        <span class="n">ran</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ord</span><span class="p">){</span>
          <span class="kt">int</span> <span class="n">rev_k</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">)</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">);</span>
          <span class="n">Comp</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class=" -RegionPink">+</span> <span class="n">conj</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">rev_k</span><span class="p">]);</span>
          <span class="n">Comp</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class=" -RegionPink">-</span> <span class="n">conj</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">rev_k</span><span class="p">]);</span>
          <span class="n">arr</span><span class="p">[</span><span class="n">tar</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">tar</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cb</span><span class="p">;</span>
        <span class="p">}</span>                                            <span class="mi">8649</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">){</span>
      <span class="n">fft</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ord</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">()){</span>
        <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(((</span><span class="n">ll</span><span class="p">)(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class=" -RegionPink">.real()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">%</span><span class="n">mod</span><span class="p">)</span>
                    <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">shift</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class=" -RegionPink">0</span><span class="p">))))</span> <span class="o">%</span> <span class="n">mod</span><span class="p">;</span>
        <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(((</span><span class="n">ll</span><span class="p">)(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class=" -RegionPink">.imag()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">%</span><span class="n">mod</span><span class="p">)</span>
                    <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">shift</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class=" -RegionPink">1</span><span class="p">))))</span> <span class="o">%</span> <span class="n">mod</span><span class="p">;</span>
      <span class="p">}</span>                                              <span class="mi">6208</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">4758</span>
<header>
<b>Fast mod mult, Rabbin Miller prime check, Pollard rho factorization O(p^0.5)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">ModArithm</span> <span class="p">{</span>
  <span class="n">ull</span> <span class="n">n</span><span class="p">;</span>
  <span class="n">ld</span> <span class="n">rec</span><span class="p">;</span>
  <span class="n">ModArithm</span><span class="p">(</span><span class="n">ull</span> <span class="n">_n</span><span class="p">)</span> <span class="o">:</span> <span class="n">n</span><span class="p">(</span><span class="n">_n</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// n in [2, 1&lt;&lt;63)</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">L</span> <span class="o">/</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// a, b in [0, min(2*n, 1&lt;&lt;63))</span>
  <span class="n">ull</span> <span class="n">multf</span><span class="p">(</span><span class="n">ull</span> <span class="n">a</span><span class="p">,</span> <span class="n">ull</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ull</span> <span class="n">mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">ld</span><span class="p">)</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">rec</span> <span class="o">+</span> <span class="mf">0.5</span><span class="n">L</span><span class="p">;</span>               <span class="mi">1609</span>
    <span class="n">ll</span> <span class="n">res</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">res</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span> <span class="c1">// in [0, n-1)</span>
  <span class="p">}</span>
  <span class="n">ull</span> <span class="n">sqp1</span><span class="p">(</span><span class="n">ull</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">multf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">7403</span>
<span class="n">ull</span> <span class="nf">pow_mod</span><span class="p">(</span><span class="n">ull</span> <span class="n">a</span><span class="p">,</span> <span class="n">ull</span> <span class="n">n</span><span class="p">,</span> <span class="n">ModArithm</span> <span class="o">&amp;</span><span class="n">arithm</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ull</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ull</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="n">res</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">multf</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>           <span class="mi">5920</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">multf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">1380</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">small_primes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">};</span>
<span class="kt">bool</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">ull</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// n &lt;= 1&lt;&lt;63, 1M rand/s</span>
  <span class="n">ModArithm</span> <span class="n">arithm</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>                 <span class="mi">8104</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">__builtin_ctzll</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">ull</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ull</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">small_primes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>                               <span class="mi">8234</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pow_mod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">arithm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">multf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>                         <span class="mi">5793</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">4147</span>
<span class="n">ll</span> <span class="nf">pollard_rho</span><span class="p">(</span><span class="n">ll</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ModArithm</span> <span class="n">arithm</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">cum_cnt</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">__builtin_clzll</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="n">cum_cnt</span> <span class="o">*=</span> <span class="n">cum_cnt</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>                                     <span class="mi">2164</span>
    <span class="n">ll</span> <span class="n">lv</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">ll</span> <span class="n">v</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">sqp1</span><span class="p">(</span><span class="n">lv</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ll</span> <span class="n">cur</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">ll</span> <span class="n">v_cur</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">j_stop</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cum_cnt</span><span class="p">,</span> <span class="n">tar</span> <span class="o">-</span> <span class="n">idx</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">j_stop</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>             <span class="mi">4557</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">multf</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">v_cur</span> <span class="o">-</span> <span class="n">lv</span><span class="p">));</span>
        <span class="n">v_cur</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">sqp1</span><span class="p">(</span><span class="n">v_cur</span><span class="p">);</span>
        <span class="o">++</span><span class="n">idx</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cum_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">ll</span> <span class="n">g</span> <span class="o">=</span> <span class="n">__gcd</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">lv</span><span class="p">),</span> <span class="n">n</span><span class="p">);</span>              <span class="mi">8079</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">sqp1</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">g</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ll</span> <span class="n">g</span> <span class="o">=</span> <span class="n">__gcd</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">g</span><span class="p">;</span>                        <span class="mi">9567</span>
      <span class="p">}</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">v_cur</span><span class="p">;</span>
      <span class="n">idx</span> <span class="o">+=</span> <span class="n">j_stop</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">tar</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="n">tar</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">arithm</span><span class="p">.</span><span class="n">sqp1</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="o">++</span><span class="n">idx</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">4128</span>
<span class="n">map</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">prime_factor</span><span class="p">(</span>
      <span class="n">ll</span> <span class="n">n</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// n &lt;= 1&lt;&lt;62, ~1000/s (&lt;500/s on CF)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">map</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">res_act</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">p</span> <span class="p">:</span> <span class="n">small_primes</span><span class="p">)</span> <span class="p">{</span>                     <span class="mi">3770</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">res_act</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
        <span class="n">n</span> <span class="o">/=</span> <span class="n">p</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">prime_factor</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_act</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">res_act</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
    <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)[</span><span class="n">n</span><span class="p">];</span>                                     <span class="mi">1963</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ll</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">pollard_rho</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">prime_factor</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="n">prime_factor</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">factor</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>                             <span class="mi">1140</span>
<span class="p">}</span> <span class="o">//</span> <span class="nl">Usage</span><span class="p">:</span> <span class="n">fact</span> <span class="o">=</span> <span class="n">prime_factor</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>                 <span class="o">%</span><span class="mi">1140</span>
<header>
<b>Berlekamp-Massey O(LN)</b>
</header>
<span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">P</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">intmod</span> <span class="p">{</span>
  <span class="n">intmod</span><span class="p">()</span> <span class="p">{}</span>
  <span class="k">constexpr</span> <span class="n">intmod</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="o">:</span> <span class="n">x</span><span class="p">((</span><span class="n">t</span> <span class="o">+</span> <span class="n">P</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">T</span> <span class="n">value</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span><span class="p">;</span> <span class="p">}</span>                      <span class="mi">4043</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">i</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">i</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">;</span>                               <span class="mi">3220</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">-=</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">P</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*=</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">ll</span><span class="p">)</span><span class="n">x</span> <span class="o">*</span> <span class="n">i</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">;</span>                           <span class="mi">6117</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">/=</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">ll</span><span class="p">)</span><span class="n">x</span> <span class="o">*</span> <span class="n">i</span><span class="p">.</span><span class="n">inverse</span><span class="p">().</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">j</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>                                  <span class="mi">5239</span>
    <span class="k">return</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="k">operator</span><span class="o">-</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">j</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">j</span> <span class="o">-=</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">j</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>                                  <span class="mi">5405</span>
    <span class="k">return</span> <span class="n">j</span> <span class="o">*=</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="k">operator</span><span class="o">/</span><span class="p">(</span><span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">j</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">j</span> <span class="o">/=</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="k">operator</span><span class="o">-</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>                   <span class="mi">8184</span>
    <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">n</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">P</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">inverse</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">P</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">aa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">ba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                                <span class="mi">6637</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">T</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">;</span>
      <span class="n">T</span> <span class="n">r</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">a</span><span class="p">;</span>
      <span class="n">ba</span> <span class="o">-=</span> <span class="n">aa</span> <span class="o">*</span> <span class="n">q</span><span class="p">;</span>
      <span class="n">bb</span> <span class="o">-=</span> <span class="n">ab</span> <span class="o">*</span> <span class="n">q</span><span class="p">;</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">aa</span><span class="p">);</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">ab</span><span class="p">);</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">+</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ba</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ix</span> <span class="o">*</span> <span class="n">x</span> <span class="o">==</span> <span class="n">unity</span><span class="p">);</span>                         <span class="mi">1934</span>
    <span class="k">return</span> <span class="n">ix</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">static</span> <span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">zero</span><span class="p">;</span>
  <span class="k">static</span> <span class="k">const</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">unity</span><span class="p">;</span>
 <span class="k">private</span><span class="o">:</span>
  <span class="n">T</span> <span class="n">x</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">P</span><span class="o">&gt;</span>                           <span class="mi">8968</span>
<span class="k">constexpr</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;::</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">P</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;::</span><span class="n">unity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">using</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">intmod</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>                        <span class="o">%</span><span class="mi">8052</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="o">&gt;</span>
<span class="k">static</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">berlekamp_massey</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">ss</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">ts</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">cs</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>                           <span class="mi">3987</span>
  <span class="n">cs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="o">::</span><span class="n">unity</span><span class="p">;</span>
  <span class="n">fill</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">K</span><span class="o">::</span><span class="n">zero</span><span class="p">);</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">K</span> <span class="n">b</span> <span class="o">=</span> <span class="n">K</span><span class="o">::</span><span class="n">unity</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ss</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">K</span> <span class="n">d</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>                                     <span class="mi">8023</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">l</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">d</span> <span class="o">+=</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ss</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">K</span><span class="o">::</span><span class="n">zero</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">K</span> <span class="n">w</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">b</span><span class="p">;</span>
      <span class="n">ts</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">m</span><span class="p">]</span> <span class="o">-=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">bs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                      <span class="mi">9661</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">l</span><span class="p">;</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
      <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">K</span> <span class="n">w</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">b</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">m</span><span class="p">]</span> <span class="o">-=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">bs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">m</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">cs</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>                                  <span class="mi">8403</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">==</span> <span class="n">K</span><span class="o">::</span><span class="n">zero</span><span class="p">)</span> <span class="n">cs</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">cs</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">8013</span>
<header>
<b>Linear algebra</b>
</header>
<span></span><span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">add</span><span class="p">(</span><span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">,</span> <span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">p</span> <span class="o">^</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">mult</span><span class="p">(</span><span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                           <span class="mi">8750</span>
    <span class="k">return</span> <span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">normalize</span><span class="p">(</span><span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>
<span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">neg</span><span class="p">(</span><span class="n">bitset</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">v</span><span class="p">;</span> <span class="p">}</span>           <span class="mi">5844</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">add</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>                                <span class="mi">2733</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">mult</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">k</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">normalize</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">mult</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="mi">1</span> <span class="o">/</span> <span class="n">v</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>                     <span class="mi">1772</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">neg</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">mult</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">1000</span>
<span class="cm">/* V is the class implementing a vector, T is the type</span>
<span class="cm"> * within. examples: &lt;bitset&lt;10&gt;, bool&gt;; &lt;vector&lt;double&gt;,</span>
<span class="cm"> * double&gt; etc. V must have an &quot;add&quot; operation defined */</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&gt;</span>
<span class="n">diagonalize</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">matrix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>           <span class="mi">9747</span>
  <span class="cm">/* width is the number of columns we consider for</span>
<span class="cm">   * diagonalizing. all columns after that can be used</span>
<span class="cm">   * for things after equal sign etc */</span>
  <span class="kt">int</span> <span class="n">cur_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">crap_columns</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">diag_columns</span><span class="p">;</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">row_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">best_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* may want to replace with epsilon</span>
<span class="cm">                       if working over reals */</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">cur_row</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">matrix</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>            <span class="mo">0164</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="n">best_val</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row_id</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
        <span class="n">best_val</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">crap_columns</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>                     <span class="mi">5068</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">diag_columns</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">cur_row</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="n">row_id</span><span class="p">]);</span>
      <span class="n">matrix</span><span class="p">[</span><span class="n">cur_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">cur_row</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">cur_row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">matrix</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                     <span class="mi">6006</span>
          <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">neg</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i</span><span class="p">)),</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">cur_row</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">cur_row</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">diag_columns</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>                                        <span class="mi">1210</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
        <span class="n">neg</span><span class="p">(</span>
          <span class="n">mult</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">diag_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]])));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">matrix</span><span class="p">,</span> <span class="p">{</span><span class="n">diag_columns</span><span class="p">,</span> <span class="n">crap_columns</span><span class="p">}};</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">9471</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">int</span> <span class="n">matrix_rank</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">matrix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">diagonalize</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>            <span class="mi">5622</span>
    <span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">6175</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">one_solution</span><span class="p">(</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">matrix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* finds one solution to the system Ax = y.</span>
<span class="cm">   * each row in matrix must have width at least width</span>
<span class="cm">   * + 1. aborts if there is no solution (you can check</span>
<span class="cm">   * whether solution exists using matrix_rank) */</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">matrix</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">y</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>                 <span class="mi">8765</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">matrix</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&gt;</span> <span class="n">prr</span> <span class="o">=</span>
    <span class="n">diagonalize</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>                <span class="mi">5091</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">diag</span> <span class="o">=</span> <span class="n">prr</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">diag_cols</span> <span class="o">=</span> <span class="n">prr</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ans</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">matrix</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>                    <span class="mi">6769</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">diag_cols</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">ans</span><span class="p">[</span><span class="n">diag_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">width</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">width</span><span class="p">]</span> <span class="o">==</span> <span class="n">T</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
      <span class="cm">/* replace with epsilon if working over reals */</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">;</span>                                        <span class="mi">4744</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">4744</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">homog_basis</span><span class="p">(</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">matrix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* finds the basis of the nullspace of matrix */</span>
  <span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;&gt;</span> <span class="n">prr</span> <span class="o">=</span>
    <span class="n">diagonalize</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>                <span class="mi">7752</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">diag</span> <span class="o">=</span> <span class="n">prr</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">diag_cols</span> <span class="o">=</span> <span class="n">prr</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">crap_cols</span> <span class="o">=</span> <span class="n">prr</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">ans</span><span class="p">;</span>                             <span class="mi">9794</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">u</span> <span class="p">:</span> <span class="n">crap_cols</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">row</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">row</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">diag_cols</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
      <span class="n">row</span><span class="p">[</span><span class="n">diag_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">u</span><span class="p">];</span>               <span class="mi">2600</span>
    <span class="n">ans</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">5812</span>
<header>
<b>Polynomial roots and O(n^2) interpolation</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Poly</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">;</span>
  <span class="kt">double</span> <span class="nf">operator</span><span class="p">()(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">(</span><span class="n">val</span> <span class="o">*=</span> <span class="n">x</span><span class="p">)</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">;</span>                                      <span class="mi">3663</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">diff</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">a</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">divroot</span><span class="p">(</span><span class="kt">double</span> <span class="n">x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">back</span><span class="p">(),</span> <span class="n">c</span><span class="p">;</span>                          <span class="mi">5829</span>
    <span class="n">a</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">2226</span>
<span></span><span class="cm">/* Description: Finds the real roots to a polynomial.</span>
<span class="cm"> * Usage: poly_roots({{2,-3,1}},-1e9,1e9) // solve</span>
<span class="cm"> * x^2-3x+2 = 0 Time: O(n^2 \log(1/\epsilon)) */</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">poly_roots</span><span class="p">(</span>
  <span class="n">Poly</span> <span class="n">p</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xmin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xmax</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="o">-</span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">ret</span><span class="p">;</span>                                <span class="mi">4231</span>
  <span class="n">Poly</span> <span class="n">der</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
  <span class="n">der</span><span class="p">.</span><span class="n">diff</span><span class="p">();</span>
  <span class="k">auto</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">poly_roots</span><span class="p">(</span><span class="n">der</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">);</span>
  <span class="n">dr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">dr</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">xmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">dr</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">dr</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>                        <span class="mi">1733</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dr</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="n">dr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">h</span> <span class="o">=</span> <span class="n">dr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kt">bool</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">^</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// while (h - l &gt; 1e-8)</span>
        <span class="kt">double</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>            <span class="mi">1929</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="n">sign</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">l</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">h</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">((</span><span class="n">l</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">2596</span>
<span></span><span class="cm">/* Description: Given $n$ points (x[i], y[i]), computes</span>
<span class="cm"> * an n-1-degree polynomial $p$ that passes through them:</span>
<span class="cm"> * $p(x) = a[0]*x^0 + ... + a[n-1]*x^{n-1}$. For</span>
<span class="cm"> * numerical precision, pick $x[k] = c*\cos(k/(n-1)*\pi),</span>
<span class="cm"> * k=0 \dots n-1$. Time: O(n^2) */</span>
<span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">vd</span><span class="p">;</span>
<span class="n">vd</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">vd</span> <span class="n">x</span><span class="p">,</span> <span class="n">vd</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vd</span> <span class="n">res</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">temp</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>                   <span class="mi">5711</span>
  <span class="kt">double</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">last</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>                        <span class="mi">8691</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">2093</span>
<header>
<b>Simplex algorithm</b>
</header>
<span></span><span class="cm">/* Description: Solves a general linear maximization</span>
<span class="cm"> * problem: maximize $c^T x$ subject to $Ax \le b$, $x</span>
<span class="cm"> * \ge 0$. Returns -inf if there is no solution, inf if</span>
<span class="cm"> * there are arbitrarily good solutions, or the maximum</span>
<span class="cm"> * value of $c^T x$ otherwise. The input vector is set to</span>
<span class="cm"> * an optimal $x$ (or in the unbounded case, an arbitrary</span>
<span class="cm"> * solution fulfilling the constraints). Numerical</span>
<span class="cm"> * stability is not guaranteed. For better performance,</span>
<span class="cm"> * define variables such that $x = 0$ is viable. Usage:</span>
<span class="cm"> * vvd A = {{1,-1}, {-1,1}, {-1,-2}};</span>
<span class="cm"> * vd b = {1,1,-4}, c = {-1,-1}, x;</span>
<span class="cm"> * T val = LPSolver(A, b, c).solve(x);</span>
<span class="cm"> * Time: O(NM * \#pivots), where a pivot may be e.g. an</span>
<span class="cm"> * edge relaxation. O(2^n) in the general case. Status:</span>
<span class="cm"> * seems to work? */</span>
<span class="k">typedef</span> <span class="kt">double</span>
  <span class="n">T</span><span class="p">;</span> <span class="c1">// long double, Rational, double + mod&lt;P&gt;...</span>
<span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">vd</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">vd</span><span class="o">&gt;</span> <span class="n">vvd</span><span class="p">;</span>
<span class="k">const</span> <span class="n">T</span> <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="n">inf</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">.0</span><span class="p">;</span>
<span class="cp">#define MP make_pair</span>
<span class="cp">#define ltj(X) \</span>                                     <span class="mi">3913</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">MP</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">MP</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span> <span class="n">s</span> <span class="o">=</span> <span class="n">j</span>
<span class="k">struct</span> <span class="n">LPSolver</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
  <span class="n">vi</span> <span class="n">N</span><span class="p">,</span> <span class="n">B</span><span class="p">;</span>
  <span class="n">vvd</span> <span class="n">D</span><span class="p">;</span>
  <span class="n">LPSolver</span><span class="p">(</span><span class="k">const</span> <span class="n">vvd</span><span class="o">&amp;</span> <span class="n">A</span><span class="p">,</span> <span class="k">const</span> <span class="n">vd</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">vd</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m</span><span class="p">(</span><span class="n">sz</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>                                      <span class="mi">2418</span>
      <span class="n">n</span><span class="p">(</span><span class="n">sz</span><span class="p">(</span><span class="n">c</span><span class="p">)),</span>
      <span class="n">N</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
      <span class="n">B</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
      <span class="n">D</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vd</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                                  <span class="mi">2216</span>
      <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
      <span class="n">D</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">N</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">D</span><span class="p">[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">pivot</span><span class="p">(</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">T</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">data</span><span class="p">(),</span> <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">a</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>              <span class="mi">1099</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">abs</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">T</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">(),</span> <span class="n">inv2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv</span><span class="p">;</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv2</span><span class="p">;</span>
      <span class="n">b</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv2</span><span class="p">;</span>                            <span class="mi">8058</span>
    <span class="p">}</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">r</span><span class="p">)</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="n">inv</span><span class="p">;</span>
    <span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span><span class="p">;</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="n">s</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">simplex</span><span class="p">(</span><span class="kt">int</span> <span class="n">phase</span><span class="p">)</span> <span class="p">{</span>                          <span class="mo">0674</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">phase</span><span class="p">)</span> <span class="n">ltj</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                                    <span class="mo">0227</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">MP</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span>
                         <span class="n">MP</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">s</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>                                     <span class="mo">0657</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">pivot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="n">solve</span><span class="p">(</span><span class="n">vd</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="n">r</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="p">{</span>                        <span class="mi">2015</span>
      <span class="n">pivot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">simplex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="n">D</span><span class="p">[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">inf</span><span class="p">;</span>
      <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ltj</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>                  <span class="mi">5590</span>
        <span class="n">pivot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">simplex</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">vd</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="n">x</span><span class="p">[</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">ok</span> <span class="o">?</span> <span class="n">D</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">inf</span><span class="p">;</span>                   <span class="mi">6872</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">3986</span>
<header>
<b>Dinic</b>
</header>
<span></span><span class="k">struct</span> <span class="n">MaxFlow</span> <span class="p">{</span>
  <span class="k">const</span> <span class="k">static</span> <span class="n">ll</span> <span class="n">INF</span> <span class="o">=</span> <span class="mf">1e18</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">start</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">adj</span><span class="p">,</span> <span class="n">rcap</span><span class="p">,</span> <span class="n">cap_loc</span><span class="p">,</span> <span class="n">bfs</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">cap</span><span class="p">,</span> <span class="n">orig_cap</span><span class="p">;</span>                         <span class="mi">2347</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  ll sink_pot = 0;</span>
<span class=" -RegionYellow">  vector&lt;bool&gt; visited;</span>
<span class=" -RegionYellow">  vector&lt;ll&gt; cost;</span>
<span class=" -RegionYellow">  priority_queue&lt;pair&lt;ll, int&gt;, vector&lt;pair&lt;ll, int&gt; &gt;,</span>
<span class=" -RegionYellow">    greater&lt;pair&lt;ll, int&gt; &gt; &gt;</span>                       <span class=" -RegionYellow"> 7035</span>
<span class=" -RegionYellow">    dist_que;</span>
  <span class="kt">void</span> <span class="nf">add_flow</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ll</span> <span class="n">flow</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cont</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cap</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">flow</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="n">add_flow</span><span class="p">(</span><span class="n">rcap</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="o">-</span><span class="n">flow</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
  <span class="p">}</span>                                                 <span class=" -RegionYellow"> 7491</span>
  <span class="n">MaxFlow</span><span class="p">(</span>                                           <span class="mi">2758</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">ll</span><span class=" -RegionYellow">, ll </span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">edges</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">edges</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">rcap</span><span class=" -RegionYellow">, cost</span>
      <span class="n">start</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">),</span> <span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">start</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span>                <span class="mi">8990</span><span class=" -RegionYellow"> 6901</span>
      <span class="o">++</span><span class="n">start</span><span class="p">[</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="o">++</span><span class="n">start</span><span class="p">[</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">start</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>                                <span class="mi">5067</span><span class=" -RegionYellow"> 7619</span>
    <span class="n">adj</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
    <span class="n">cap</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
    <span class="n">rcap</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">back</span><span class="p">());</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">    cost.resize(start.back());</span>                      <span class=" -RegionYellow"> 8183</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">edges</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>                                      <span class="mi">2600</span>
      <span class="n">ll</span> <span class="n">c</span><span class="p">,</span> <span class="n">rc</span><span class=" -RegionYellow">, c_cost</span><span class="p">;</span>
      <span class="n">tie</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">rc</span><span class=" -RegionYellow">, c_cost</span><span class="p">)</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">u</span> <span class="o">!=</span> <span class="n">v</span><span class="p">);</span>
      <span class="n">adj</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
      <span class="n">adj</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>                              <span class=" -RegionYellow"> 9009</span>
      <span class="n">rcap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span> <span class="o">=</span> <span class="n">now</span><span class="p">[</span><span class="n">v</span><span class="p">];</span>
      <span class="n">rcap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span> <span class="o">=</span> <span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>                         <span class="mi">3424</span>
      <span class="n">cap_loc</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]);</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">      cost[now[u]] = c_cost;</span>
<span class=" -RegionYellow">      cost[now[v]] = -c_cost;</span>                       <span class=" -RegionYellow"> 1155</span>
      <span class="n">cap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">cap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
      <span class="n">orig_cap</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">dinic_bfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">min_cap</span><span class="p">)</span> <span class="p">{</span>                      <span class="mi">1782</span>
    <span class="n">lvl</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">lvl</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>                       <span class=" -RegionYellow"> 1409</span>
    <span class="n">bfs</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">bfs</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">lvl</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">bfs</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>                     <span class="mi">7194</span>
      <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">bfs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">[</span><span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>               <span class=" -RegionYellow"> 4157</span>
        <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">adj</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]];</span>
        <span class="k">if</span> <span class="p">(</span><span class=" -RegionYellow">cost[now[u]] == 0 &amp;&amp;</span>
            <span class="n">cap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">min_cap</span> <span class="o">&amp;&amp;</span> <span class="n">lvl</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">lvl</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">lvl</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>                       <span class="mo">02</span><span class="mi">92</span>
          <span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="n">sink</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>                  <span class=" -RegionYellow"> 9445</span>
          <span class="n">bfs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">ll</span> <span class="n">dinic_dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span> <span class="n">flow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_cap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">sink</span><span class="p">)</span> <span class="k">return</span> <span class="n">flow</span><span class="p">;</span>                 <span class="mo">02</span><span class="mi">86</span><span class=" -RegionYellow"> 0667</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">==</span> <span class="n">lvl</span><span class="p">[</span><span class="n">sink</span><span class="p">])</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ll</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">[</span><span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">adj</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">==</span> <span class="n">lvl</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class=" -RegionYellow"> &amp;&amp; cost[now[u]] == 0</span> <span class="o">&amp;&amp;</span>
          <span class="n">cap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">min_cap</span><span class="p">)</span> <span class="p">{</span>             <span class="mi">3898</span><span class=" -RegionYellow"> 5811</span>
        <span class="n">ll</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">dinic_dfs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="n">cap</span><span class="p">[</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">]]),</span>
            <span class="n">min_cap</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">add_flow</span><span class="p">(</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">cur</span><span class="p">);</span>
          <span class="n">flow</span> <span class="o">-=</span> <span class="n">cur</span><span class="p">;</span>
          <span class="n">res</span> <span class="o">+=</span> <span class="n">cur</span><span class="p">;</span>                           <span class="mi">8689</span><span class=" -RegionYellow"> 6305</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="o">++</span><span class="n">now</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
  <span class="p">}</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  bool recalc_dist(bool check_imp = false) {</span>
<span class=" -RegionYellow">    now = start;</span>
<span class=" -RegionYellow">    visited.clear();</span>                                <span class=" -RegionYellow"> 2399</span>
<span class=" -RegionYellow">    visited.resize(start.size());</span>
<span class=" -RegionYellow">    dist_que.emplace(0, source);</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">    bool imp = false;</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">    while (!dist_que.empty()) {</span>
<span class=" -RegionYellow">      int u;</span>                                        <span class=" -RegionPink"> 1146</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">      ll dist;</span>
<span class=" -RegionYellow">      tie(dist, u) = dist_que.top();</span>                <span class=" -RegionYellow"> 7076</span>
<span class=" -RegionYellow">      dist_que.pop();</span>
<span class=" -RegionYellow">      if (!visited[u]) {</span>
<span class=" -RegionYellow">        visited[u] = true;</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">        if (check_imp &amp;&amp; dist != 0) imp = true;</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">        if (u == sink) sink_pot += dist;</span>            <span class=" -RegionPink"> 1736</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">        while (now[u] &lt; start[u + 1]) {</span>
<span class=" -RegionYellow">          int v = adj[now[u]];</span>                      <span class=" -RegionYellow"> 1746</span>
<span class=" -RegionYellow">          if (!visited[v] &amp;&amp; cap[now[u]])</span>
<span class=" -RegionYellow">            dist_que.emplace(dist + cost[now[u]], v);</span>
<span class=" -RegionYellow">          cost[now[u]] += dist;</span>                     <span class=" -RegionPink"> 6628</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">          cost[rcap[now[u]++]] -= dist;</span>             <span class=" -RegionYellow"> 3870</span>
<span class=" -RegionYellow">        }</span>
<span class=" -RegionYellow">      }</span>
<span class=" -RegionYellow">    }</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">    if (check_imp) return imp;</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">    return visited[sink];</span>
<span class=" -RegionYellow">  }</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">  // return whether there is a negative cycle</span>
<span class=" -RegionPink">  bool recalc_dist_bellman_ford() {</span>                 <span class=" -RegionPink"> 6214</span>
<span class=" -RegionPink">    int i = 0;</span>
<span class=" -RegionPink">    for (; i &lt; (int)start.size() - 1 &amp;&amp;</span>
<span class=" -RegionPink">        recalc_dist(true); ++i) {}</span>
<span class=" -RegionPink">    return i == (int)start.size() - 1;</span>
<span class=" -RegionPink">  }</span>
  <span class=" -RegionYellow">pair&lt;ll, </span><span class="n">ll</span><span class=" -RegionYellow">&gt;</span> <span class="n">calc_flow</span><span class="p">(</span><span class="kt">int</span> <span class="n">_source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_sink</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">_source</span><span class="p">;</span>                               <span class=" -RegionPink"> 7113</span>
    <span class="n">sink</span> <span class="o">=</span> <span class="n">_sink</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">    ll tot_flow = 0;</span>                            <span class="mo">0704</span><span class=" -RegionYellow"> 0619</span>
<span class=" -RegionYellow">    ll tot_cost = 0;</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">    if (recalc_dist_bellman_ford()) {</span>               <span class=" -RegionPink"> 8769</span>
<span class=" -RegionPink">      assert(false);</span>
<span class=" -RegionPink">    } else {</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">        while (recalc_dist()){</span>
        <span class="n">ll</span> <span class="n">flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">min_cap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">;</span> <span class="n">min_cap</span><span class="p">;</span> <span class="n">min_cap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">){</span>
          <span class="k">while</span> <span class="p">(</span><span class="n">dinic_bfs</span><span class="p">(</span><span class="n">min_cap</span><span class="p">))</span> <span class="p">{</span>              <span class=" -RegionYellow"> 9291</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>                            <span class=" -RegionPink"> 6673</span>
            <span class="n">ll</span> <span class="n">cur</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">dinic_dfs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">INF</span><span class="p">,</span> <span class="n">min_cap</span><span class="p">))</span>
              <span class="n">flow</span> <span class="o">+=</span> <span class="n">cur</span><span class="p">;</span>                           <span class="mi">8615</span>
          <span class="p">}</span>
        <span class="p">}</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">        tot_flow += flow;</span>
<span class=" -RegionYellow">        tot_cost += sink_pot * flow;</span>                <span class=" -RegionYellow"> 8204</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class=" -RegionYellow">{tot_</span><span class="n">flow</span><span class=" -RegionYellow">, tot_cost}</span><span class="p">;</span>                    <span class=" -RegionPink"> 9075</span>
  <span class="p">}</span>                                       <span class="o">%</span><span class="mi">6688</span><span class=" -RegionYellow">%9207</span><span class=" -RegionPink">%9075</span>
  <span class="n">ll</span> <span class="nf">flow_on_edge</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">cap</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">orig_cap</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">cap</span><span class="p">[</span><span class="n">cap_loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]];</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">2070</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">nmax</span> <span class="o">=</span> <span class="mi">1055</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">ll</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">edges</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">edges</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">card</span><span class="p">;</span>
      <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
      <span class="n">edges</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">ex_c</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex_c</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ex_c</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
      <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">)</span> <span class="n">swap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
      <span class="n">edges</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">edges</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">edges</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">MaxFlow</span> <span class="n">mf</span><span class="p">(</span><span class="n">edges</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mf</span><span class="p">.</span><span class="n">calc_flow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">second</span><span class="p">);</span>
    <span class="c1">//cout &lt;&lt; mf.flow_on_edge(edge_index) &lt;&lt; endl;</span>
  <span class="p">}</span>
<span class="p">}</span>
<header>
<b>Min Cost Max Flow with Cycle Cancelling O(Cnm)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Network</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">Node</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Edge</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">cost</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="nf">from</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">u</span><span class="p">)</span> <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">u</span><span class="p">;</span>                                      <span class="mi">9547</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">getCap</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">u</span><span class="p">)</span> <span class="k">return</span> <span class="n">c</span> <span class="o">-</span> <span class="n">f</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">addFlow</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">toAdd</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="n">toAdd</span><span class="p">;</span>                                  <span class="mi">1565</span>
        <span class="k">return</span> <span class="n">toAdd</span> <span class="o">*</span> <span class="n">cost</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">f</span> <span class="o">-=</span> <span class="n">toAdd</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">toAdd</span> <span class="o">*</span> <span class="n">cost</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Edge</span><span class="o">*&gt;</span> <span class="n">conn</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="n">deque</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span><span class="p">;</span>                                 <span class="mi">4534</span>
  <span class="n">deque</span><span class="o">&lt;</span><span class="n">Edge</span><span class="o">&gt;</span> <span class="n">edges</span><span class="p">;</span>
  <span class="n">Node</span><span class="o">*</span> <span class="nf">addNode</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">nodes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Node</span><span class="p">());</span>
    <span class="n">nodes</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">index</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">nodes</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>                            <span class="mi">3762</span>
  <span class="p">}</span>
  <span class="n">Edge</span><span class="o">*</span> <span class="n">addEdge</span><span class="p">(</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">u</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cost</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">edges</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">cost</span><span class="p">});</span>
    <span class="n">u</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edges</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>                <span class="mi">5814</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edges</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">edges</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">// Assumes all needed flow has already been added</span>
  <span class="kt">int</span> <span class="n">minCostMaxFlow</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                  <span class="mi">7253</span>
    <span class="k">struct</span> <span class="n">State</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
      <span class="n">Edge</span><span class="o">*</span> <span class="n">used</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">state</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}));</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">lev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lev</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">lev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>            <span class="mi">3158</span>
        <span class="n">state</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">lev</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">lev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
              <span class="n">state</span><span class="p">[</span><span class="n">lev</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">[</span><span class="n">lev</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Edge</span><span class="o">*</span> <span class="nl">edge</span> <span class="p">:</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="o">-&gt;</span><span class="n">getCap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">np</span> <span class="o">=</span>                             <span class="mi">7871</span>
                  <span class="n">state</span><span class="p">[</span><span class="n">lev</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">edge</span><span class="o">-&gt;</span><span class="n">u</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                        <span class="o">?</span> <span class="n">edge</span><span class="o">-&gt;</span><span class="nl">cost</span>
                                        <span class="p">:</span> <span class="o">-</span><span class="n">edge</span><span class="o">-&gt;</span><span class="n">cost</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">ni</span> <span class="o">=</span> <span class="n">edge</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">[</span><span class="n">lev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">ni</span><span class="p">].</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">state</span><span class="p">[</span><span class="n">lev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">ni</span><span class="p">].</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
                  <span class="n">state</span><span class="p">[</span><span class="n">lev</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">ni</span><span class="p">].</span><span class="n">used</span> <span class="o">=</span> <span class="n">edge</span><span class="p">;</span>
                <span class="p">}</span>                                    <span class="mi">8767</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// Now look at the last level</span>
      <span class="kt">bool</span> <span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">state</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="n">vector</span><span class="o">&lt;</span><span class="n">Edge</span><span class="o">*&gt;</span> <span class="n">path</span><span class="p">;</span>                        <span class="mi">4080</span>
          <span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">1000000000</span><span class="p">;</span>
          <span class="n">Node</span><span class="o">*</span> <span class="n">cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="kt">int</span> <span class="n">clev</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
          <span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">explr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
          <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">explr</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>               <span class="mi">5898</span>
            <span class="n">explr</span><span class="p">[</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">State</span> <span class="n">cstate</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">clev</span><span class="p">][</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">cstate</span><span class="p">.</span><span class="n">used</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
            <span class="n">path</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cstate</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>             <span class="mi">7277</span>
          <span class="p">}</span>
          <span class="n">reverse</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">path</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
          <span class="p">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Node</span><span class="o">*</span> <span class="n">cur2</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
            <span class="k">do</span> <span class="p">{</span>
              <span class="n">cur2</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="n">cur2</span><span class="p">);</span>
              <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cur2</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">);</span>                   <span class="mi">9838</span>
            <span class="n">path</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">edge</span> <span class="p">:</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cap</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">edge</span><span class="o">-&gt;</span><span class="n">getCap</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">edge</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">edge</span> <span class="p">:</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>                   <span class="mi">6010</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">edge</span><span class="o">-&gt;</span><span class="n">addFlow</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">edge</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">4029</span>
<header>
<b>Global Min Cut O(V^3)</b>
</header>
<span></span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">vi</span><span class="o">&gt;</span> <span class="n">GetMinCut</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vi</span><span class="o">&gt;&amp;</span> <span class="n">weights</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">sz</span><span class="p">(</span><span class="n">weights</span><span class="p">);</span>
  <span class="n">vi</span> <span class="nf">used</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">cut</span><span class="p">,</span> <span class="n">best_cut</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">best_weight</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                              <span class="mi">9745</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">phase</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phase</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vi</span> <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">added</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">prev</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rep</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">prev</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
      <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                                        <span class="mi">4363</span>
      <span class="n">rep</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">added</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">phase</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rep</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="n">weights</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
        <span class="n">rep</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">prev</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">prev</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
        <span class="n">used</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>                              <span class="mi">3181</span>
        <span class="n">cut</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">best_weight</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_weight</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">best_cut</span> <span class="o">=</span> <span class="n">cut</span><span class="p">;</span>
          <span class="n">best_weight</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">rep</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="n">w</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
        <span class="n">added</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>                             <span class="mi">2381</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">best_weight</span><span class="p">,</span> <span class="n">best_cut</span><span class="p">};</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">8654</span>
<header>
<b>Aho Corasick O(|alpha|*sum(len))</b>
</header>
<span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">alpha_size</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">nxt</span><span class="p">[</span><span class="n">alpha_size</span><span class="p">];</span> <span class="c1">// May use other structures to</span>
                         <span class="c1">// move in trie</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">suffix</span><span class="p">;</span>
  <span class="n">Node</span><span class="p">()</span> <span class="p">{</span> <span class="n">memset</span><span class="p">(</span><span class="n">nxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="p">));</span> <span class="p">}</span>
  <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                       <span class="mi">1006</span>
<span class="p">};</span>
<span class="n">Node</span> <span class="o">*</span><span class="nf">aho_corasick</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">dict</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">;</span>
  <span class="n">root</span><span class="o">-&gt;</span><span class="n">suffix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">,</span> <span class="n">Node</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="n">state</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nl">s</span> <span class="p">:</span> <span class="n">dict</span><span class="p">)</span>                       <span class="mi">2117</span>
    <span class="n">state</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">,</span> <span class="n">Node</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="n">nstate</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>                        <span class="mi">9306</span>
      <span class="n">Node</span> <span class="o">*</span><span class="n">nxt</span> <span class="o">=</span> <span class="n">cur</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[(</span><span class="o">*</span><span class="n">cur</span><span class="p">.</span><span class="n">first</span><span class="p">)[</span><span class="n">i</span><span class="p">]];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nxt</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cur</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">nxt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">;</span>
        <span class="n">cur</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[(</span><span class="o">*</span><span class="n">cur</span><span class="p">.</span><span class="n">first</span><span class="p">)[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">;</span>
        <span class="n">Node</span> <span class="o">*</span><span class="n">suf</span> <span class="o">=</span> <span class="n">cur</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">;</span>              <span class="mi">5283</span>
        <span class="n">cur</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">;</span>
        <span class="n">nxt</span><span class="o">-&gt;</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span> <span class="c1">// set correct suffix link</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">suf</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">suf</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[(</span><span class="o">*</span><span class="n">cur</span><span class="p">.</span><span class="n">first</span><span class="p">)[</span><span class="n">i</span><span class="p">]])</span> <span class="p">{</span>
            <span class="n">nxt</span><span class="o">-&gt;</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suf</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[(</span><span class="o">*</span><span class="n">cur</span><span class="p">.</span><span class="n">first</span><span class="p">)[</span><span class="n">i</span><span class="p">]];</span>
            <span class="k">break</span><span class="p">;</span>                                   <span class="mi">3580</span>
          <span class="p">}</span>
          <span class="n">suf</span> <span class="o">=</span> <span class="n">suf</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nstate</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">nstate</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">8654</span>
<span class="c1">// auxilary functions for searhing and counting</span>
<span class="n">Node</span> <span class="o">*</span><span class="nf">walk</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// longest prefix in dict that is suffix of</span>
            <span class="c1">// walked string.</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">return</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">)</span> <span class="k">return</span> <span class="n">cur</span><span class="p">;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">;</span>                               <span class="mi">3162</span>
  <span class="p">}</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">1423</span>
<span class="kt">void</span> <span class="nf">cnt_matches</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">match_in</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">match_in</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">walk</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="o">++</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span>                                      <span class="mo">0015</span>
  <span class="p">}</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">3991</span>
<span class="kt">void</span> <span class="nf">add_cnt</span><span class="p">(</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// After counting matches propagete ONCE</span>
                <span class="c1">// to suffixes for final counts</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span> <span class="o">*&gt;</span> <span class="n">to_visit</span> <span class="o">=</span> <span class="p">{</span><span class="n">root</span><span class="p">};</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to_visit</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">to_visit</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha_size</span><span class="p">)</span> <span class="p">{</span>                          <span class="mo">0662</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">to_visit</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">to_visit</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
    <span class="n">to_visit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">+=</span> <span class="n">to_visit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>                                                   <span class="o">%</span><span class="mi">7950</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
  <span class="n">a</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="o">&amp;</span><span class="nl">c</span> <span class="p">:</span> <span class="n">a</span><span class="p">)</span> <span class="n">c</span> <span class="o">-=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">dict</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resize</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">());</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pop_back</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="o">&amp;</span><span class="nl">c</span> <span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">c</span> <span class="o">-=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">aho_corasick</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
  <span class="n">cnt_matches</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="n">add_cnt</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">walk</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<header>
<b>Suffix automaton and tree O((n+q)log(|alpha|)) - 10+M length/s</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Node</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">P</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span> <span class="c1">// Length of longest suffix in equivalence</span>
  <span class="n">P</span> <span class="n">suf</span><span class="p">;</span>   <span class="c1">// class.</span>
  <span class="kt">char</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">Node</span><span class="p">(</span><span class="kt">int</span> <span class="n">_len</span><span class="p">)</span> <span class="o">:</span> <span class="n">len</span><span class="p">(</span><span class="n">_len</span><span class="p">)</span> <span class="p">{};</span>                     <span class="mi">5245</span>
  <span class="n">Node</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">_act</span><span class="p">,</span> <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">_out</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">_len</span><span class="p">,</span> <span class="n">P</span> <span class="o">&amp;</span><span class="n">_suf</span><span class="p">,</span>
       <span class="kt">int</span> <span class="n">_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_cap</span><span class="p">)</span> <span class="o">:</span> <span class="n">act</span><span class="p">(</span><span class="n">_act</span><span class="p">),</span> <span class="n">len</span><span class="p">(</span><span class="n">_len</span><span class="p">),</span>
       <span class="n">suf</span><span class="p">(</span><span class="n">_suf</span><span class="p">),</span> <span class="n">size</span><span class="p">(</span><span class="n">_size</span><span class="p">),</span> <span class="n">cap</span><span class="p">(</span><span class="n">_cap</span><span class="p">)</span> <span class="p">{</span>           <span class="mi">2571</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">_out</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">has_nxt</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">act</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">P</span> <span class="n">nxt</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>                                    <span class="mi">5014</span>
    <span class="k">return</span>
      <span class="n">out</span><span class="p">[</span><span class="n">__builtin_popcount</span><span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">))];</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">set_nxt</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="n">P</span> <span class="n">nxt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">__builtin_popcount</span><span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">has_nxt</span><span class="p">(</span><span class="n">c</span><span class="p">)){</span>                                  <span class="mi">8690</span>
      <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">cap</span><span class="p">){</span>
        <span class="n">cap</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
          <span class="n">cap</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span> <span class="n">nout</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">&lt;</span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
        <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
          <span class="n">nout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                          <span class="mi">8164</span>
        <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
          <span class="n">nout</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">dealloc</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">nout</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;</span><span class="n">idx</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
          <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>                         <span class="mi">4046</span>
      <span class="p">}</span>
      <span class="n">act</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="p">));</span>
      <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">;</span>
      <span class="o">++</span><span class="n">size</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">P</span> <span class="n">split</span><span class="p">(</span><span class="kt">int</span> <span class="n">new_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">suf</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">new_len</span><span class="p">,</span>
        <span class="n">suf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>                             <span class="mi">8441</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">8441</span>
  <span class="c1">// Extra functions for matching and counting</span>
  <span class="n">P</span> <span class="nf">lower</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// move to longest suf of current with a maximum</span>
    <span class="c1">// length of depth.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">suf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">depth</span><span class="p">)</span> <span class="k">return</span> <span class="n">suf</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">P</span> <span class="nf">walk</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">match_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// move to longest suffix of walked path that is a</span>
    <span class="o">//</span> <span class="n">substring</span>                                     <span class="mi">3466</span>
    <span class="n">match_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">match_len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="c1">// includes depth limit(needed for finding matches)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">has_nxt</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// as suffixes are in classes,</span>
             <span class="c1">// match_len must be tracked externally</span>
      <span class="o">++</span><span class="n">match_len</span><span class="p">;</span>
      <span class="k">return</span> <span class="nf">nxt</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">suf</span><span class="p">)</span> <span class="k">return</span> <span class="n">suf</span><span class="o">-&gt;</span><span class="n">walk</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">match_len</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="k">this</span><span class="p">;</span>                                  <span class="mi">4494</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">4494</span>
  <span class="kt">bool</span> <span class="n">vis</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class=" -RegionYellow">bool vis_t = false;</span>
  <span class=" -RegionPink">int paths_to_end = 0;</span>
<span class=" -RegionPink">  void set_as_end() { // All suffixes of current node are</span>
<span class=" -RegionPink">    paths_to_end += 1;// marked as ending nodes.</span>
<span class=" -RegionPink">    if (suf) suf-&gt;set_as_end();</span>                     <span class=" -RegionPink"> 0905</span>
<span class=" -RegionPink">  }</span>
<span class=" -RegionPink">  void calc_paths() {</span>
<span class=" -RegionPink">    /* Call ONCE from ROOT. For each node  calculates</span>
<span class=" -RegionPink">     * number of ways to reach an end node. paths_to_end</span>
<span class=" -RegionPink">     * is ocurence count for any strings in current</span>
<span class=" -RegionPink">     * suffix equivalence class. */</span>
<span class=" -RegionPink">    if (!vis) {</span>
<span class=" -RegionPink">      vis = true;</span>
<span class=" -RegionPink">      ran(i, 0, size){</span>
<span class=" -RegionPink">        out[i]-&gt;calc_paths();</span>
<span class=" -RegionPink">        paths_to_end += out[i]-&gt;paths_to_end;</span>
<span class=" -RegionPink">      }</span>                                             <span class=" -RegionPink"> 0806</span>
<span class=" -RegionPink">    }</span>
<span class=" -RegionPink">  }</span>
  <span class=" -RegionYellow">// Transform into suffix tree of reverse string</span>
<span class=" -RegionYellow">  P tree_links[26];</span>
<span class=" -RegionYellow">  int end_d_v = 1 &lt;&lt; 30;</span>
<span class=" -RegionYellow">  int end_d() {</span>
<span class=" -RegionYellow">    if (end_d_v == 1 &lt;&lt; 30) {</span>
<span class=" -RegionYellow">      ran(i, 0, size){</span>                              <span class=" -RegionYellow"> 2648</span>
<span class=" -RegionYellow">        end_d_v = min(end_d_v, 1 + out[i]-&gt;end_d());</span>
<span class=" -RegionYellow">      }</span>                                             <span class=" -RegionPink"> 6170</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">      if (end_d_v == 1 &lt;&lt; 30)</span>
<span class=" -RegionYellow">        end_d_v = 0;</span>
<span class=" -RegionYellow">    }</span>
<span class=" -RegionYellow">    return end_d_v;</span>
<span class=" -RegionYellow">  }</span>
<span class=" -RegionYellow">  void build_suffix_tree(</span>                           <span class=" -RegionYellow"> 6985</span>
<span class=" -RegionYellow">    string &amp;s) { // Call ONCE from ROOT.</span>
<span class=" -RegionYellow">    if (!vis_t) {</span>
<span class=" -RegionYellow">      vis_t = true;</span>
<span class=" -RegionYellow">      if (suf)</span>                                      <span class=" -RegionPink"> 4268</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">        suf-&gt;tree_links[s[(int)s.size() - end_d() -</span>
<span class=" -RegionYellow">                          suf-&gt;len - 1]-&#39;a&#39;] = (P)this;</span>
<span class=" -RegionYellow">      ran(i, 0, size){</span>                              <span class=" -RegionYellow"> 2958</span>
<span class=" -RegionYellow">        out[i]-&gt;build_suffix_tree(s);</span>               <span class=" -RegionPink"> 1410</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">      }</span>
<span class=" -RegionYellow">    }</span>
<span class=" -RegionYellow">  }</span>
<span class="p">};</span>                                        <span class="o">%</span><span class="mi">7187</span><span class=" -RegionYellow">%1877</span><span class=" -RegionPink">%5307</span>
<span class="k">struct</span> <span class="n">SufAuto</span> <span class="p">{</span>
  <span class="n">P</span> <span class="n">last</span><span class="p">;</span>
  <span class="n">P</span> <span class="n">root</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">extend</span><span class="p">(</span><span class="kt">char</span> <span class="n">new_c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">P</span> <span class="n">nlast</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">P</span> <span class="n">swn</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">swn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">swn</span><span class="o">-&gt;</span><span class="n">has_nxt</span><span class="p">(</span><span class="n">new_c</span><span class="p">))</span> <span class="p">{</span>            <span class="mi">7641</span>
      <span class="n">swn</span><span class="o">-&gt;</span><span class="n">set_nxt</span><span class="p">(</span><span class="n">new_c</span><span class="p">,</span> <span class="n">nlast</span><span class="p">);</span>
      <span class="n">swn</span> <span class="o">=</span> <span class="n">swn</span><span class="o">-&gt;</span><span class="n">suf</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">swn</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">nlast</span><span class="o">-&gt;</span><span class="n">suf</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">P</span> <span class="n">max_sbstr</span> <span class="o">=</span> <span class="n">swn</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">(</span><span class="n">new_c</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">swn</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">max_sbstr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">nlast</span><span class="o">-&gt;</span><span class="n">suf</span> <span class="o">=</span> <span class="n">max_sbstr</span><span class="p">;</span>                      <span class="mi">1138</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// remove for minimal DFA that matches</span>
               <span class="c1">// suffixes and crap</span>
        <span class="n">P</span> <span class="n">eq_sbstr</span> <span class="o">=</span> <span class="n">max_sbstr</span><span class="o">-&gt;</span><span class="n">split</span><span class="p">(</span><span class="n">swn</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">nlast</span><span class="o">-&gt;</span><span class="n">suf</span> <span class="o">=</span> <span class="n">eq_sbstr</span><span class="p">;</span>
        <span class="n">P</span> <span class="n">x</span> <span class="o">=</span> <span class="n">swn</span><span class="p">;</span> <span class="c1">// x = with_edge_to_eq_sbstr</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">nxt</span><span class="p">(</span><span class="n">new_c</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_sbstr</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">x</span><span class="o">-&gt;</span><span class="n">set_nxt</span><span class="p">(</span><span class="n">new_c</span><span class="p">,</span> <span class="n">eq_sbstr</span><span class="p">);</span>               <span class="mi">1131</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">suf</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">nlast</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">SufAuto</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">root</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">s</span><span class="p">)</span> <span class="n">extend</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">    // To build suffix tree use reversed string</span>
<span class=" -RegionYellow">    root-&gt;build_suffix_tree(s);</span>                     <span class=" -RegionYellow"> 1055</span>
  <span class="p">}</span>
<span class="p">};</span>                                             <span class="o">%</span><span class="mi">5553</span><span class=" -RegionYellow">%5020</span>
<header>
<b>Palindromic tree O(n)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">palindromic_tree</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">[</span><span class="n">MAXN</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="n">MAXN</span><span class="p">],</span> <span class="n">cnt</span><span class="p">[</span><span class="n">MAXN</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="n">MAXN</span><span class="p">];</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">to</span><span class="p">[</span><span class="n">MAXN</span><span class="p">];</span>                  <span class="mi">3118</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">fill</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">to</span> <span class="o">+</span> <span class="n">MAXN</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">());</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="p">));</span>                   <span class="mi">5652</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cnt</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">len</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">palindromic_tree</span><span class="p">()</span> <span class="p">{</span> <span class="n">clear</span><span class="p">();</span> <span class="p">}</span>                    <span class="mo">00</span><span class="mi">82</span>
  <span class="kt">int</span> <span class="nf">get_link</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">len</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="n">v</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="n">v</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="nf">tr</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">it</span> <span class="p">:</span> <span class="n">to</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="k">return</span> <span class="n">it</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>           <span class="mi">1937</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">add_letter</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">get_link</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">len</span><span class="p">[</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">link</span><span class="p">[</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="p">(</span><span class="n">get_link</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">cur</span><span class="p">]),</span> <span class="n">c</span><span class="p">);</span>
      <span class="n">to</span><span class="p">[</span><span class="n">cur</span><span class="p">].</span><span class="n">push_back</span><span class="p">({</span><span class="n">c</span><span class="p">,</span> <span class="n">sz</span><span class="o">++</span><span class="p">});</span>                  <span class="mi">4761</span>
    <span class="p">}</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">tr</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">cnt</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="n">last</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">3854</span>
<header>
<b>DMST O(E log V)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">EdgeDesc</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">DMST</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">Node</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">Edge</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">tar</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">w</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">inc</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="k">struct</span> <span class="n">Circle</span> <span class="p">{</span>                                    <span class="mi">9251</span>
    <span class="kt">bool</span> <span class="n">vis</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Edge</span> <span class="o">*&gt;</span> <span class="n">cont</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">clean</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="k">const</span> <span class="k">static</span> <span class="n">greater</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="n">Edge</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="n">comp</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Circle</span><span class="o">&gt;</span> <span class="n">to_proc</span><span class="p">;</span>                     <span class="mi">8693</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">no_dmst</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">Node</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span> <span class="c1">// Can use inline static since C++17</span>
  <span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">out_cands</span><span class="p">;</span> <span class="c1">// Circ, edge idx</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="n">Edge</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="n">con</span><span class="p">;</span>                   <span class="mi">8937</span>
    <span class="kt">bool</span> <span class="n">in_use</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">ll</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// extra to add to edges in con</span>
    <span class="n">Node</span> <span class="o">*</span><span class="nf">anc</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">par</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">par</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span> <span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">par</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="nf">clean</span><span class="p">()</span> <span class="p">{</span>                                   <span class="mo">0300</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_dmst</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">in_use</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">out_cands</span><span class="p">)</span>
          <span class="n">to_proc</span><span class="p">[</span><span class="n">cur</span><span class="p">.</span><span class="n">first</span><span class="p">].</span><span class="n">clean</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">con_to_root</span><span class="p">()</span> <span class="p">{</span>                            <span class="mi">6779</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">anc</span><span class="p">()</span> <span class="o">==</span> <span class="n">root</span><span class="p">)</span> <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
      <span class="n">in_use</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">Node</span> <span class="o">*</span><span class="n">super</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="c1">// Will become root or the first Node encountered</span>
      <span class="c1">// in a loop.</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">super</span> <span class="o">==</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">con</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
               <span class="n">con</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">tar</span><span class="o">-&gt;</span><span class="n">anc</span><span class="p">()</span> <span class="o">==</span> <span class="n">anc</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">pop_heap</span><span class="p">(</span><span class="n">con</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">con</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">comp</span><span class="p">);</span>
          <span class="n">con</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>                            <span class="mi">1880</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">no_dmst</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pop_heap</span><span class="p">(</span><span class="n">con</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">con</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">comp</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">nxt</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
        <span class="n">con</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>                              <span class="mi">1711</span>
        <span class="n">w</span> <span class="o">=</span> <span class="o">-</span><span class="n">nxt</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nxt</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">tar</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">super</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">tar</span><span class="o">-&gt;</span><span class="n">anc</span><span class="p">();</span>
          <span class="n">to_proc</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">to_proc</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                                     <span class="mi">6356</span>
          <span class="n">super</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">tar</span><span class="o">-&gt;</span><span class="n">con_to_root</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">super</span> <span class="o">!=</span> <span class="n">root</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">to_proc</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">cont</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">nxt</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
          <span class="n">out_cands</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">to_proc</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">to_proc</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">cont</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="o">//</span> <span class="n">Clean</span> <span class="n">circles</span>                    <span class="mi">7094</span>
          <span class="n">nxt</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">inc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="n">nxt</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">clean</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">super</span> <span class="o">!=</span> <span class="n">root</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// we are some loops non first Node.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">con</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">swap</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">);</span>                     <span class="mo">01</span><span class="mi">98</span>
          <span class="c1">// Largest con in loop should not be copied.</span>
          <span class="n">swap</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">cur</span> <span class="p">:</span> <span class="n">con</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">super</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span>
            <span class="n">cur</span><span class="p">.</span><span class="n">first</span> <span class="o">-</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">cur</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
          <span class="n">push_heap</span><span class="p">(</span>                                 <span class="mi">2509</span>
            <span class="n">super</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">con</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">comp</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">par</span> <span class="o">=</span> <span class="n">super</span><span class="p">;</span> <span class="c1">// root or anc() of first Node</span>
                   <span class="c1">// encountered in a loop</span>
      <span class="k">return</span> <span class="n">super</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">croot</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">graph</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">Edge</span><span class="o">&gt;</span> <span class="n">edges</span><span class="p">;</span>                                <span class="mo">0270</span>
  <span class="n">DMST</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">EdgeDesc</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Self loops and multiple edges are okay.</span>
    <span class="n">graph</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">croot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">graph</span><span class="p">[</span><span class="n">r</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">desc</span><span class="p">)</span>
      <span class="c1">// Edges are reversed internally</span>
      <span class="n">edges</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>                               <span class="mi">2636</span>
        <span class="n">Edge</span><span class="p">{</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">[</span><span class="n">cur</span><span class="p">.</span><span class="n">to</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">graph</span><span class="p">[</span><span class="n">cur</span><span class="p">.</span><span class="n">from</span><span class="p">],</span> <span class="n">cur</span><span class="p">.</span><span class="n">w</span><span class="p">});</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">desc</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">graph</span><span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">to</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span>            <span class="mi">5825</span>
        <span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">make_heap</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">comp</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">find</span><span class="p">()</span> <span class="p">{</span>                                      <span class="mo">0310</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">croot</span><span class="p">;</span>
    <span class="n">no_dmst</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">graph</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cur</span><span class="p">.</span><span class="n">con_to_root</span><span class="p">();</span>
      <span class="n">to_proc</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">no_dmst</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>                     <span class="mi">3580</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class=" -RegionYellow">ll weight() {</span>
<span class=" -RegionYellow">    ll res = 0;</span>
<span class=" -RegionYellow">    for (auto &amp;cur : edges) {</span>
<span class=" -RegionYellow">      if (cur.inc) res += cur.w;</span>
<span class=" -RegionYellow">    }</span>
<span class=" -RegionYellow">    return res;</span>
<span class=" -RegionYellow">  }</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="n">DMST</span><span class="o">::</span><span class="n">Circle</span><span class="o">::</span><span class="n">clean</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>                 <span class=" -RegionYellow"> 8969</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vis</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cont</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>                                <span class="mi">2000</span>
        <span class="n">cont</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">inc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">cont</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">clean</span><span class="p">();</span>                     <span class=" -RegionYellow"> 5761</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">const</span> <span class="n">greater</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">ll</span><span class="p">,</span> <span class="n">DMST</span><span class="o">::</span><span class="n">Edge</span> <span class="o">*&gt;</span> <span class="o">&gt;</span> <span class="n">DMST</span><span class="o">::</span><span class="n">comp</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">DMST</span><span class="o">::</span><span class="n">Circle</span><span class="o">&gt;</span> <span class="n">DMST</span><span class="o">::</span><span class="n">to_proc</span><span class="p">;</span>                  <span class="mi">4425</span>
<span class="kt">bool</span> <span class="n">DMST</span><span class="o">::</span><span class="n">no_dmst</span><span class="p">;</span>                                 <span class=" -RegionYellow"> 7169</span>
<span class="n">DMST</span><span class="o">::</span><span class="n">Node</span> <span class="o">*</span><span class="n">DMST</span><span class="o">::</span><span class="n">root</span><span class="p">;</span>                        <span class="o">%</span><span class="mi">1911</span><span class=" -RegionYellow">%7169</span>
<header>
<b>Dominator tree O(NlogN)</b>
</header>
<span></span><span class=" -RegionYellow">struct Tree {</span>
<span class=" -RegionYellow">  /* insert structure here */</span>
<span class=" -RegionYellow">  void set_root(int u) {</span>
<span class=" -RegionYellow">    </span><span class=" -RegionPink">cout &lt;&lt; &quot;root is &quot; &lt;&lt; u &lt;&lt; endl;</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  }</span>
<span class=" -RegionYellow">  void add_edge(int u, int v) {</span>
<span class=" -RegionYellow">    </span><span class=" -RegionPink">cout &lt;&lt; u &lt;&lt; &quot;-&gt;&quot; &lt;&lt; v &lt;&lt; endl;</span>                 <span class=" -RegionPink"> 9295</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  }</span>
<span class=" -RegionYellow">};</span>
<span class="k">struct</span> <span class="n">Graph</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">in_edges</span><span class="p">,</span> <span class="n">out_edges</span><span class="p">;</span>          <span class=" -RegionYellow"> 4936</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ord</span><span class="p">,</span> <span class="n">dfs_idx</span><span class="p">,</span> <span class="n">parent</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sdom</span><span class="p">,</span> <span class="n">idom</span><span class="p">;</span>                       <span class="mi">3559</span><span class=" -RegionPink"> 2843</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">rsdom</span><span class="p">;</span> <span class="cm">/* inverse of sdom */</span>
  <span class="cm">/* slightly modified version of dsu-s root[] */</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">dsu</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">label</span><span class="p">;</span>                                <span class=" -RegionYellow"> 8541</span>
  <span class="kt">void</span> <span class="nf">dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">par</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">vis</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ord</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>                         <span class="mi">7901</span><span class=" -RegionPink"> 9919</span>
    <span class="n">parent</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
    <span class="n">dfs_idx</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ord</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>             <span class=" -RegionYellow"> 7813</span>
    <span class="n">vis</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">nxt</span> <span class="p">:</span> <span class="n">out_edges</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">in_edges</span><span class="p">[</span><span class="n">nxt</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>             <span class="mi">9341</span><span class=" -RegionPink"> 8446</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vis</span><span class="p">[</span><span class="n">nxt</span><span class="p">])</span>
        <span class="n">dfs</span><span class="p">(</span><span class="n">nxt</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="n">vis</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">add_edge</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>                     <span class=" -RegionYellow"> 1297</span>
    <span class="n">out_edges</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Graph</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">in_edges</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>              <span class="mi">2678</span>
    <span class="n">out_edges</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>            <span class=" -RegionYellow"> 3692</span>
    <span class="n">rsdom</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>                <span class=" -RegionPink"> 2528</span>
    <span class="n">dfs_idx</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">parent</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>                            <span class="mi">5034</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sdom</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>                            <span class=" -RegionYellow"> 3309</span>
      <span class="n">idom</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="n">dsu</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>                             <span class=" -RegionPink"> 6047</span>
      <span class="n">label</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">find</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                       <span class="mi">1942</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">dsu</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                                  <span class=" -RegionYellow"> 7922</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">dsu</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>                    <span class=" -RegionPink"> 5963</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">u</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dfs_idx</span><span class="p">[</span><span class="n">sdom</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="n">dsu</span><span class="p">[</span><span class="n">u</span><span class="p">]]]]</span> <span class="o">&lt;</span>               <span class="mi">5992</span>
        <span class="n">dfs_idx</span><span class="p">[</span><span class="n">sdom</span><span class="p">[</span><span class="n">label</span><span class="p">[</span><span class="n">u</span><span class="p">]]])</span> <span class="p">{</span>                  <span class=" -RegionYellow"> 0401</span>
            <span class="n">label</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">dsu</span><span class="p">[</span><span class="n">u</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="n">dsu</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>                                     <span class=" -RegionPink"> 2576</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">?</span> <span class="nl">v</span> <span class="p">:</span> <span class="n">label</span><span class="p">[</span><span class="n">u</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">merge</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">dsu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span> <span class="p">}</span>           <span class="mi">7954</span>
  <span class="n">Tree</span> <span class="nf">dom_tree</span><span class="p">(</span><span class="kt">int</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span>                          <span class=" -RegionYellow"> 7503</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vis</span><span class="p">(</span><span class="n">idom</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>                <span class=" -RegionPink"> 5374</span>
    <span class="n">dfs</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vis</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ord</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">ord</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                                <span class="mi">5015</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">v</span> <span class="p">:</span> <span class="n">in_edges</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="p">{</span>                   <span class=" -RegionYellow"> 3975</span>
        <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>                            <span class=" -RegionPink"> 4547</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dfs_idx</span><span class="p">[</span><span class="n">sdom</span><span class="p">[</span><span class="n">u</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">dfs_idx</span><span class="p">[</span><span class="n">sdom</span><span class="p">[</span><span class="n">w</span><span class="p">]])</span> <span class="p">{</span>
          <span class="n">sdom</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdom</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rsdom</span><span class="p">[</span><span class="n">sdom</span><span class="p">[</span><span class="n">u</span><span class="p">]].</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>            <span class="mo">0705</span><span class=" -RegionYellow"> 4218</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">w</span> <span class="p">:</span> <span class="n">rsdom</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="p">{</span>                      <span class=" -RegionPink"> 7099</span>
        <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sdom</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">==</span> <span class="n">sdom</span><span class="p">[</span><span class="n">w</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">idom</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdom</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">idom</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">merge</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">u</span><span class="p">);</span>                    <span class="mi">8824</span><span class=" -RegionYellow"> 8104</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">Tree</span> <span class="n">ans</span><span class="p">;</span> <span class="cm">/* if your constructor needs # of vertices,</span>
<span class="cm">               * use (int) idom.size() + 5 for example */</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ord</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>                    <span class=" -RegionPink"> 6999</span>
      <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="n">ord</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">idom</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sdom</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">idom</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">idom</span><span class="p">[</span><span class="n">idom</span><span class="p">[</span><span class="n">u</span><span class="p">]];</span>
      <span class="p">}</span>
      <span class="n">ans</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">idom</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">u</span><span class="p">);</span>                 <span class="mi">5230</span><span class=" -RegionYellow"> 2307</span>
    <span class="p">}</span>
    <span class="n">ans</span><span class="p">.</span><span class="n">set_root</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ans</span><span class="p">;</span>                                     <span class=" -RegionPink"> 6690</span>
  <span class="p">}</span>
<span class="p">};</span>                                        <span class="o">%</span><span class="mi">7388</span><span class=" -RegionYellow">%1935</span><span class=" -RegionPink">%7257</span>
<header>
<b>Bridges O(n)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">vert</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">edge</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">exists</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">vert</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
  <span class="n">edge</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
  <span class="n">edge</span><span class="p">(</span><span class="n">vert</span> <span class="o">*</span><span class="n">_dest</span><span class="p">)</span> <span class="o">:</span> <span class="n">dest</span><span class="p">(</span><span class="n">_dest</span><span class="p">)</span> <span class="p">{</span> <span class="n">rev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">vert</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span> <span class="p">}</span>                <span class="mi">8609</span>
  <span class="n">vert</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">dest</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">is_bridge</span><span class="p">();</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">vert</span> <span class="p">{</span>
  <span class="n">deque</span><span class="o">&lt;</span><span class="n">edge</span><span class="o">&gt;</span> <span class="n">con</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">seen</span><span class="p">;</span>
  <span class="kt">int</span> <span class="nf">dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">upd</span><span class="p">,</span> <span class="n">edge</span> <span class="o">*</span><span class="n">ban</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// handles multiple edges</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>                                      <span class="mi">1288</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">upd</span><span class="p">;</span>
      <span class="n">seen</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">edge</span> <span class="o">&amp;</span><span class="nl">nxt</span> <span class="p">:</span> <span class="n">con</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nxt</span><span class="p">.</span><span class="n">exists</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">nxt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ban</span><span class="p">)</span>
          <span class="n">seen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">seen</span><span class="p">,</span> <span class="n">nxt</span><span class="o">-&gt;</span><span class="n">dfs</span><span class="p">(</span><span class="n">upd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxt</span><span class="p">.</span><span class="n">rev</span><span class="p">));</span>
      <span class="p">}</span>                                              <span class="mi">8194</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">seen</span><span class="p">;</span>
  <span class="p">}</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  void remove_adj_bridges() {</span>
<span class=" -RegionYellow">    for (edge &amp;nxt : con) {</span>
<span class=" -RegionYellow">      if (nxt.is_bridge()) nxt.exists = false;</span>
<span class=" -RegionYellow">    }</span>
<span class=" -RegionYellow">  }</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">  int cnt_adj_bridges() {</span>                           <span class=" -RegionPink"> 0310</span>
<span class=" -RegionPink">    int res = 0;</span>
<span class=" -RegionPink">    for (edge &amp;nxt : con) res += nxt.is_bridge();</span>
<span class=" -RegionPink">    return res;</span>
<span class=" -RegionPink">  }</span>
<span class="p">};</span>
<span class="kt">bool</span> <span class="n">edge</span><span class="o">::</span><span class="n">is_bridge</span><span class="p">()</span> <span class="p">{</span>                            <span class=" -RegionYellow"> 4882</span>
  <span class="k">return</span> <span class="n">exists</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">seen</span> <span class="o">&gt;</span> <span class="n">rev</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">||</span>
                     <span class="n">dest</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">rev</span><span class="o">-&gt;</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">seen</span><span class="p">);</span>
<span class="p">}</span>                                         <span class="o">%</span><span class="mi">3548</span><span class=" -RegionYellow">%8614</span><span class=" -RegionPink">%4558</span>
<span class="n">vert</span> <span class="n">graph</span><span class="p">[</span><span class="n">nmax</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Mechanics Practice BRIDGES</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="n">m</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">graph</span> <span class="o">+</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">graph</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">graph</span> <span class="o">+</span> <span class="n">u</span><span class="p">);</span>
    <span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">rev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">graph</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
    <span class="n">graph</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">rev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">con</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">graph</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dfs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">+=</span> <span class="n">graph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cnt_adj_bridges</span><span class="p">();</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">res</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
<header>
<b>2-Sat O(n) and SCC O(n)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Graph</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">con</span><span class="p">;</span>
  <span class="n">Graph</span><span class="p">(</span><span class="kt">int</span> <span class="n">nsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">nsize</span><span class="p">;</span>
    <span class="n">con</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">add_edge</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="n">con</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">v</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">top_dfs</span><span class="p">(</span><span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">explr</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">revcon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">explr</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="k">return</span><span class="p">;</span>                          <span class="mi">1224</span>
    <span class="n">explr</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">next</span> <span class="p">:</span> <span class="n">revcon</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
      <span class="n">top_dfs</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">explr</span><span class="p">,</span> <span class="n">revcon</span><span class="p">);</span>
    <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">topsort</span><span class="p">()</span> <span class="p">{</span>                            <span class="mi">7420</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">revcon</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">v</span> <span class="p">:</span> <span class="n">con</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="n">revcon</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">explr</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>                    <span class="mi">2387</span>
    <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="n">top_dfs</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">explr</span><span class="p">,</span> <span class="n">revcon</span><span class="p">);</span>
    <span class="n">reverse</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  void dfs(</span>                                         <span class=" -RegionYellow"> 5654</span>
<span class=" -RegionYellow">    int pos, vector&lt;int&gt; &amp;result, vector&lt;bool&gt; &amp;explr) {</span>
<span class=" -RegionYellow">    if (explr[pos]) return;</span>
<span class=" -RegionYellow">    explr[pos] = true;</span>
<span class=" -RegionYellow">    for (auto next : con[pos]) dfs(next, result, explr);</span>
<span class=" -RegionYellow">    result.push_back(pos);</span>                          <span class=" -RegionYellow"> 0239</span>
<span class=" -RegionYellow">  }</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">  vector&lt;vector&lt;int&gt; &gt; scc() {</span>
<span class=" -RegionPink">    vector&lt;int&gt; order = topsort();</span>
<span class=" -RegionPink">    reverse(order.begin(), order.end());</span>
<span class=" -RegionPink">    vector&lt;bool&gt; explr(n, false);</span>                   <span class=" -RegionPink"> 6484</span>
<span class=" -RegionPink">    vector&lt;vector&lt;int&gt; &gt; res;</span>
<span class=" -RegionPink">    for (auto it = order.rbegin(); it != order.rend();</span>
<span class=" -RegionPink">         ++it) {</span>
<span class=" -RegionPink">      vector&lt;int&gt; comp;</span>
<span class=" -RegionPink">      top_dfs(*it, comp, explr, con);</span>               <span class=" -RegionPink"> 5220</span>
<span class=" -RegionPink">      sort(comp.begin(), comp.end());</span>
<span class=" -RegionPink">      res.push_back(comp);</span>
<span class=" -RegionPink">    }</span>
<span class=" -RegionPink">    sort(res.begin(), res.end());</span>
<span class=" -RegionPink">    return res;</span>
<span class=" -RegionPink">  }</span>
<span class="p">};</span>                                        <span class="o">%</span><span class="mo">0503</span><span class=" -RegionYellow">%6965</span><span class=" -RegionPink">%4511</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">Graph</span> <span class="n">g</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="p">);</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sb</span><span class="p">;</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="n">sa</span> <span class="o">&gt;&gt;</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="p">;</span>
    <span class="n">a</span><span class="o">--</span><span class="p">,</span> <span class="n">b</span><span class="o">--</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sa</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">sb</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">sa</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">state</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">order</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">topsort</span><span class="p">();</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">explr</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">u</span> <span class="p">:</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">traversed</span><span class="p">;</span>
      <span class="n">g</span><span class="p">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">traversed</span><span class="p">,</span> <span class="n">explr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">traversed</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
          <span class="o">!</span><span class="n">state</span><span class="p">[</span><span class="n">traversed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">c</span> <span class="p">:</span> <span class="n">traversed</span><span class="p">)</span> <span class="n">state</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;IMPOSSIBLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ran</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<header>
<b>Templated multi dimensional BIT O(log(n)^d) per query</b>
</header>
<span></span><span class="c1">// Fully overloaded any dimensional BIT, use any type for</span>
<span class="c1">// coordinates, elements, return_value. Includes</span>
<span class="c1">// coordinate compression.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">E_T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">C_T</span><span class="p">,</span> <span class="n">C_T</span> <span class="n">n_inf</span><span class="p">,</span> <span class="k">class</span> <span class="nc">R_T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">BIT</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">C_T</span><span class="o">&gt;</span> <span class="n">pos</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">E_T</span><span class="o">&gt;</span> <span class="n">elems</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">act</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>                                  <span class="mi">9342</span>
  <span class="n">BIT</span><span class="p">()</span> <span class="p">{</span> <span class="n">pos</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">n_inf</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">E_T</span> <span class="o">&amp;</span><span class="nl">c_elem</span> <span class="p">:</span> <span class="n">elems</span><span class="p">)</span> <span class="n">c_elem</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">act</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">sort</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">pos</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>                  <span class="mi">6080</span>
      <span class="n">pos</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span>
        <span class="n">unique</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">pos</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="o">-</span> <span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
      <span class="n">elems</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">loc_form</span><span class="o">&gt;</span>                    <span class="mi">5478</span>
  <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">C_T</span> <span class="n">cx</span><span class="p">,</span> <span class="n">loc_form</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">pos</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">cx</span><span class="p">)</span> <span class="o">-</span>
              <span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pos</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">x</span> <span class="o">+=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
        <span class="n">elems</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span>                    <span class="mi">5773</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">pos</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">loc_form</span><span class="o">&gt;</span>
  <span class="n">R_T</span> <span class="n">query</span><span class="p">(</span>
    <span class="n">C_T</span> <span class="n">cx</span><span class="p">,</span> <span class="n">loc_form</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// sum in (-inf, cx)</span>
    <span class="n">R_T</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">pos</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">cx</span><span class="p">)</span> <span class="o">-</span>
            <span class="n">pos</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>                         <span class="mi">9513</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
      <span class="n">res</span> <span class="o">+=</span> <span class="n">elems</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">query</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">I_T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">wrapped</span> <span class="p">{</span>
  <span class="n">I_T</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                         <span class="mi">7930</span>
  <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">I_T</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="n">a</span> <span class="o">+=</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">I_T</span> <span class="nf">query</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">;</span> <span class="p">}</span>
  <span class="c1">// Should never be called, needed for compilation</span>
  <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span> <span class="n">DEBUG</span><span class="p">(</span><span class="sc">&#39;i&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">update</span><span class="p">()</span> <span class="p">{</span> <span class="n">DEBUG</span><span class="p">(</span><span class="sc">&#39;u&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mo">01</span><span class="mi">86</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// retun type should be same as type inside wrapped</span>
  <span class="n">BIT</span><span class="o">&lt;</span><span class="n">BIT</span><span class="o">&lt;</span><span class="n">wrapped</span><span class="o">&lt;</span><span class="n">ll</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">INT_MIN</span><span class="p">,</span> <span class="n">ll</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">INT_MIN</span><span class="p">,</span>
    <span class="n">ll</span><span class="o">&gt;</span>
    <span class="n">fenwick</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ll</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">to_insert</span><span class="p">;</span>
  <span class="n">to_insert</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="c1">// set up all pos that are to be used for update</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">to_insert</span><span class="p">)</span>
      <span class="n">fenwick</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">),</span> <span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
    <span class="c1">// May include value which won&#39;t be used</span>
    <span class="n">fenwick</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">// actual use</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">cur</span> <span class="p">:</span> <span class="n">to_insert</span><span class="p">)</span>
    <span class="n">fenwick</span><span class="p">.</span><span class="n">update</span><span class="p">(</span>
      <span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">),</span> <span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">),</span> <span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cur</span><span class="p">));</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">fenwick</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="p">}</span>
<header>
<b>Treap O(log (n)) per query</b>
</header>
<span></span><span class="n">mt19937</span> <span class="n">randgen</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Treap</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>
    <span class="n">ll</span> <span class="n">total</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">lch</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">rch</span><span class="p">;</span>                                       <span class="mi">0909</span>
    <span class="n">Node</span><span class="p">(</span><span class="kt">int</span> <span class="n">new_key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">new_key</span><span class="p">;</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
      <span class="n">priority</span> <span class="o">=</span> <span class="n">randgen</span><span class="p">();</span>
      <span class="n">total</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
      <span class="n">lch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">rch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                       <span class="mi">8691</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">update</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">total</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">lch</span><span class="p">)</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">lch</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">rch</span><span class="p">)</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">rch</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="n">deque</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span><span class="p">;</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">root</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                    <span class="mi">9983</span>
  <span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*</span><span class="p">,</span> <span class="n">Node</span><span class="o">*&gt;</span> <span class="n">split</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
    <span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*</span><span class="p">,</span> <span class="n">Node</span><span class="o">*&gt;</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>                           <span class="mi">7646</span>
      <span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
      <span class="n">cur</span><span class="o">-&gt;</span><span class="n">lch</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">ret</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">cur</span><span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">);</span>               <span class="mi">5818</span>
      <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rch</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">cur</span><span class="p">,</span> <span class="n">ret</span><span class="p">.</span><span class="n">second</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="n">cur</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">merge</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">left</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>             <span class="mi">1748</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">right</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">left</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">top</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">right</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">left</span><span class="o">-&gt;</span><span class="n">rch</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>           <span class="mo">0054</span>
      <span class="n">top</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">right</span><span class="o">-&gt;</span><span class="n">lch</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
      <span class="n">top</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">top</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">top</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">insert</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>                  <span class="mi">8465</span>
    <span class="n">nodes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Node</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nodes</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
    <span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*</span><span class="p">,</span> <span class="n">Node</span><span class="o">*&gt;</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>                     <span class="mi">1599</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">ret</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">erase</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">mid</span><span class="p">,</span> <span class="o">*</span><span class="n">right</span><span class="p">;</span>
    <span class="n">tie</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>               <span class="mi">1926</span>
    <span class="n">tie</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mid</span><span class="p">);</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">ll</span> <span class="n">sum_upto</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                          <span class="mi">1009</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">sum_upto</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">ll</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span> <span class="n">sum_upto</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">lch</span><span class="p">)</span> <span class="n">result</span> <span class="o">+=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">lch</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>                                 <span class="mi">6764</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">ll</span> <span class="n">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">sum_upto</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_upto</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">1936</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">ios_base</span><span class="o">::</span><span class="n">sync_with_stdio</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
  <span class="n">cin</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">Treap</span> <span class="n">treap</span><span class="p">;</span>
  <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">m</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">type</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
      <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">y</span><span class="p">;</span>
      <span class="n">treap</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
      <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">x</span><span class="p">;</span>
      <span class="n">treap</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
      <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">;</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">treap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<header>
<b>Generic persistent compressed lazy segment tree</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Seg</span> <span class="p">{</span>
  <span class="n">ll</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">recalc</span><span class="p">(</span><span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">lhs_seg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lhs_len</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Seg</span> <span class="o">&amp;</span><span class="n">rhs_seg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rhs_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="n">lhs_seg</span><span class="p">.</span><span class="n">sum</span> <span class="o">+</span> <span class="n">rhs_seg</span><span class="p">.</span><span class="n">sum</span><span class="p">;</span>                 <span class="mi">7684</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="k">struct</span> <span class="n">Lazy</span> <span class="p">{</span>
  <span class="n">ll</span> <span class="n">add</span><span class="p">;</span>
  <span class="n">ll</span> <span class="n">assign_val</span><span class="p">;</span> <span class="c1">// LLONG_MIN if no assign;</span>
  <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">assign_val</span> <span class="o">=</span> <span class="n">LLONG_MIN</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Lazy</span><span class="p">()</span> <span class="p">{</span> <span class="n">init</span><span class="p">();</span> <span class="p">}</span>                                 <span class="mi">2819</span>
  <span class="kt">void</span> <span class="nf">split</span><span class="p">(</span><span class="n">Lazy</span> <span class="o">&amp;</span><span class="n">lhs_lazy</span><span class="p">,</span> <span class="n">Lazy</span> <span class="o">&amp;</span><span class="n">rhs_lazy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lhs_lazy</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="n">rhs_lazy</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="n">init</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">merge</span><span class="p">(</span><span class="n">Lazy</span> <span class="o">&amp;</span><span class="n">oth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>                   <span class="mi">8470</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">oth</span><span class="p">.</span><span class="n">assign_val</span> <span class="o">!=</span> <span class="n">LLONG_MIN</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">assign_val</span> <span class="o">=</span> <span class="n">oth</span><span class="p">.</span><span class="n">assign_val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">add</span> <span class="o">+=</span> <span class="n">oth</span><span class="p">.</span><span class="n">add</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">apply_to_seg</span><span class="p">(</span><span class="n">Seg</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">assign_val</span> <span class="o">!=</span> <span class="n">LLONG_MIN</span><span class="p">)</span> <span class="p">{</span>                   <span class="mi">7562</span>
      <span class="n">cur</span><span class="p">.</span><span class="n">sum</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">assign_val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">add</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>                          <span class="o">%</span><span class="mi">7609</span>
<span class="k">struct</span> <span class="n">Node</span> <span class="p">{</span> <span class="c1">// Following code should not need to be</span>
              <span class="c1">// modified</span>
  <span class="kt">int</span> <span class="n">ver</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">is_lazy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">Seg</span> <span class="n">seg</span><span class="p">;</span>
  <span class="n">Lazy</span> <span class="n">lazy</span><span class="p">;</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">lc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lc</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">{</span><span class="n">ver</span><span class="p">};</span>                            <span class="mi">6808</span>
      <span class="n">rc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">{</span><span class="n">ver</span><span class="p">};</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">Node</span> <span class="o">*</span><span class="n">upd</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">R</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">Lazy</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tar_ver</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">!=</span> <span class="n">tar_ver</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Node</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>                   <span class="mi">8874</span>
      <span class="n">rep</span><span class="o">-&gt;</span><span class="n">ver</span> <span class="o">=</span> <span class="n">tar_ver</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tar_ver</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;=</span> <span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="n">R</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">val</span><span class="p">.</span><span class="n">apply_to_seg</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">);</span>
      <span class="n">lazy</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">);</span>                        <span class="mo">0020</span>
      <span class="n">is_lazy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">init</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">is_lazy</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Lazy</span> <span class="n">l_val</span><span class="p">,</span> <span class="n">r_val</span><span class="p">;</span>
        <span class="n">lazy</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">l_val</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">);</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">l_val</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
        <span class="n">is_lazy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>                             <span class="mi">9948</span>
      <span class="p">}</span>
      <span class="n">Lazy</span> <span class="n">l_val</span><span class="p">,</span> <span class="n">r_val</span><span class="p">;</span>
      <span class="n">val</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">l_val</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">l_val</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">M</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">)</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
      <span class="n">seg</span><span class="p">.</span><span class="n">recalc</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">seg</span><span class="p">,</span> <span class="n">M</span> <span class="o">-</span> <span class="n">L</span><span class="p">,</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">seg</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">M</span><span class="p">);</span>
    <span class="p">}</span>                                                <span class="mi">8245</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">R</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">Seg</span> <span class="o">*&amp;</span><span class="n">lft_res</span><span class="p">,</span>
    <span class="n">Seg</span> <span class="o">*&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">last_ver</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">L</span> <span class="o">&gt;=</span> <span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="n">R</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">recalc</span><span class="p">(</span><span class="o">*</span><span class="n">lft_res</span><span class="p">,</span> <span class="n">L</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">);</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">lft_res</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>                            <span class="mi">8394</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">init</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">is_lazy</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Lazy</span> <span class="n">l_val</span><span class="p">,</span> <span class="n">r_val</span><span class="p">;</span>
        <span class="n">lazy</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">l_val</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">R</span> <span class="o">-</span> <span class="n">L</span><span class="p">);</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">l_val</span><span class="p">,</span> <span class="n">ver</span> <span class="o">+</span> <span class="n">last_ver</span><span class="p">);</span>
        <span class="n">lc</span><span class="o">-&gt;</span><span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="p">;</span>                               <span class="mi">2185</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">ver</span> <span class="o">+</span> <span class="n">last_ver</span><span class="p">);</span>
        <span class="n">rc</span><span class="o">-&gt;</span><span class="n">ver</span> <span class="o">=</span> <span class="n">ver</span><span class="p">;</span>
        <span class="n">is_lazy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">lc</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">lft_res</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">last_ver</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">M</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">)</span>                                     <span class="mi">9755</span>
        <span class="n">rc</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">lft_res</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">last_ver</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="k">struct</span> <span class="n">SegTree</span> <span class="p">{</span> <span class="c1">// indexes start from 0, ranges are</span>
                 <span class="c1">// [beg, end)</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span> <span class="o">*&gt;</span> <span class="n">roots</span><span class="p">;</span> <span class="c1">// versions start from 0</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>                                           <span class="mi">4873</span>
  <span class="n">SegTree</span><span class="p">(</span><span class="kt">int</span> <span class="n">_len</span><span class="p">)</span> <span class="o">:</span> <span class="n">len</span><span class="p">(</span><span class="n">_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">roots</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">new</span> <span class="n">Node</span><span class="p">{</span><span class="mi">0</span><span class="p">});</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">upd</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">Lazy</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">new_ver</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">cur_root</span> <span class="o">=</span> <span class="n">roots</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">upd</span><span class="p">(</span>              <span class="mi">3935</span>
      <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">roots</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="o">!</span><span class="n">new_ver</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur_root</span> <span class="o">!=</span> <span class="n">roots</span><span class="p">.</span><span class="n">back</span><span class="p">())</span>
      <span class="n">roots</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cur_root</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">roots</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>                         <span class="mi">1461</span>
  <span class="p">}</span>
  <span class="n">Seg</span> <span class="n">get</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">roots</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Seg</span> <span class="n">seg1</span><span class="p">,</span> <span class="n">seg2</span><span class="p">;</span>
    <span class="n">Seg</span> <span class="o">*</span><span class="n">pres</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">seg1</span><span class="p">,</span> <span class="o">*</span><span class="n">ptmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">seg2</span><span class="p">;</span>
    <span class="n">roots</span><span class="p">[</span><span class="n">ver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span>                                 <span class="mi">7894</span>
      <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">pres</span><span class="p">,</span> <span class="n">ptmp</span><span class="p">,</span> <span class="n">roots</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">pres</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">3905</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span> <span class="c1">// solves Mechanics Practice LAZY</span>
  <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">SegTree</span> <span class="n">seg_tree</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Lazy</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">assign_val</span><span class="p">);</span>
    <span class="n">seg_tree</span><span class="p">.</span><span class="n">upd</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">o</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d %d %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
    <span class="o">--</span><span class="n">l</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Lazy</span> <span class="n">tmp</span><span class="p">;</span>
      <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">add</span><span class="p">);</span>
      <span class="n">seg_tree</span><span class="p">.</span><span class="n">upd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Lazy</span> <span class="n">tmp</span><span class="p">;</span>
      <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">assign_val</span><span class="p">);</span>
      <span class="n">seg_tree</span><span class="p">.</span><span class="n">upd</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Seg</span> <span class="n">res</span> <span class="o">=</span> <span class="n">seg_tree</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">sum</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<header>
<b>Templated HLD O(M(n) log n) per query</b>
</header>
<span></span><span class="k">class</span> <span class="nc">dummy</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">dummy</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">dummy</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{}</span>
  <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{}</span>
  <span class="kt">int</span> <span class="n">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&lt;&lt;</span> <span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&lt;&lt;</span> <span class="n">right</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>                                                  <span class="mi">6131</span>
<span class="p">};</span>                                                  <span class="o">%</span><span class="mi">6131</span>
<span class="cm">/* T should be the type of the data stored in each</span>
<span class="cm"> * vertex; DS should be the underlying data structure</span>
<span class="cm"> * that is used to peform the group operation. It should</span>
<span class="cm"> * have the following methods:</span>
<span class="cm"> * * DS () - empty constructor</span>
<span class="cm"> * * DS (int size, T initial) - constructs the structure</span>
<span class="cm"> * with the given size, initially filled with initial.</span>
<span class="cm"> * * void set (int index, T value) - set the value at</span>
<span class="cm"> * index `index` to `value`</span>
<span class="cm"> * * T query (int left, int right) - return the &quot;sum&quot; of</span>
<span class="cm"> * elements between left and right, inclusive.</span>
<span class="cm"> */</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">DS</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">HLD</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">vertexc</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">adj</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">subtree_size</span><span class="p">;</span>
  <span class="n">DS</span> <span class="n">structure</span><span class="p">;</span>
  <span class="n">DS</span> <span class="n">aux</span><span class="p">;</span>                                            <span class="mi">7513</span>
  <span class="kt">void</span> <span class="nf">build_sizes</span><span class="p">(</span><span class="kt">int</span> <span class="n">vertex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">subtree_size</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">child</span> <span class="p">:</span> <span class="n">adj</span><span class="p">[</span><span class="n">vertex</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>                         <span class="mi">7279</span>
        <span class="n">build_sizes</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">vertex</span><span class="p">);</span>
        <span class="n">subtree_size</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">+=</span> <span class="n">subtree_size</span><span class="p">[</span><span class="n">child</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">cur</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ord</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">chain_root</span><span class="p">;</span>                            <span class="mi">3893</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">par</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">build_hld</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">vertex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chain_source</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cur</span><span class="o">++</span><span class="p">;</span>
    <span class="n">ord</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
    <span class="n">chain_root</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_source</span><span class="p">;</span>               <span class="mo">070</span><span class="mi">8</span>
    <span class="n">par</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">vertex</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">vertex</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">adj</span><span class="p">[</span><span class="n">vertex</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">big_child</span><span class="p">,</span> <span class="n">big_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>                  <span class="mi">7661</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">child</span> <span class="p">:</span> <span class="n">adj</span><span class="p">[</span><span class="n">vertex</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">child</span> <span class="o">!=</span> <span class="n">parent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">subtree_size</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">big_size</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">big_child</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
          <span class="n">big_size</span> <span class="o">=</span> <span class="n">subtree_size</span><span class="p">[</span><span class="n">child</span><span class="p">];</span>            <span class="mi">7393</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">build_hld</span><span class="p">(</span><span class="n">big_child</span><span class="p">,</span> <span class="n">vertex</span><span class="p">,</span> <span class="n">chain_source</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">child</span> <span class="p">:</span> <span class="n">adj</span><span class="p">[</span><span class="n">vertex</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">child</span> <span class="o">!=</span> <span class="n">parent</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="n">big_child</span><span class="p">))</span>
          <span class="n">build_hld</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">vertex</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>           <span class="mi">8363</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">HLD</span><span class="p">(</span><span class="kt">int</span> <span class="n">_vertexc</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vertexc</span> <span class="o">=</span> <span class="n">_vertexc</span><span class="p">;</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">[</span><span class="n">vertexc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">add_edge</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">adj</span><span class="p">[</span><span class="n">u</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>                             <span class="mi">8422</span>
    <span class="n">adj</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">build</span><span class="p">(</span><span class="n">T</span> <span class="n">initial</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">subtree_size</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vertexc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
    <span class="n">ord</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vertexc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>                  <span class="mi">6999</span>
    <span class="n">chain_root</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vertexc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vertexc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">build_sizes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">build_hld</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                             <span class="mi">7373</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">DS</span><span class="p">(</span><span class="n">vertexc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">initial</span><span class="p">);</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="n">DS</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">initial</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">int</span> <span class="n">vertex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">structure</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">ord</span><span class="p">[</span><span class="n">vertex</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>               <span class="mi">8170</span>
  <span class="p">}</span>
  <span class="n">T</span> <span class="n">query_path</span><span class="p">(</span><span class="kt">int</span> <span class="n">u</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* returns the &quot;sum&quot; of the path u-&gt;v */</span>
    <span class="kt">int</span> <span class="n">cur_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">chain_root</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chain_root</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ord</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ord</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">cur_id</span><span class="o">++</span><span class="p">;</span>
        <span class="n">aux</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cur_id</span><span class="p">,</span>                              <span class="mi">3518</span>
          <span class="n">structure</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">ord</span><span class="p">[</span><span class="n">chain_root</span><span class="p">[</span><span class="n">u</span><span class="p">]],</span> <span class="n">ord</span><span class="p">[</span><span class="n">u</span><span class="p">]));</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="n">chain_root</span><span class="p">[</span><span class="n">u</span><span class="p">]];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cur_id</span><span class="o">++</span><span class="p">;</span>
        <span class="n">aux</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cur_id</span><span class="p">,</span>
          <span class="n">structure</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">ord</span><span class="p">[</span><span class="n">chain_root</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="n">ord</span><span class="p">[</span><span class="n">v</span><span class="p">]));</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="n">chain_root</span><span class="p">[</span><span class="n">v</span><span class="p">]];</span>                      <span class="mi">3845</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">cur_id</span><span class="o">++</span><span class="p">;</span>
    <span class="n">aux</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">cur_id</span><span class="p">,</span> <span class="n">structure</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">ord</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">ord</span><span class="p">[</span><span class="n">v</span><span class="p">]),</span>
                      <span class="n">max</span><span class="p">(</span><span class="n">ord</span><span class="p">[</span><span class="n">u</span><span class="p">],</span> <span class="n">ord</span><span class="p">[</span><span class="n">v</span><span class="p">])));</span>
    <span class="k">return</span> <span class="n">aux</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cur_id</span><span class="p">);</span>                     <span class="mi">7150</span>
  <span class="p">}</span>                                                 <span class="o">%</span><span class="mi">7150</span>
  <span class="kt">void</span> <span class="nf">print</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">vertexc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&lt;&lt;</span> <span class="n">ord</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&lt;&lt;</span> <span class="n">chain_root</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
           <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span> <span class="o">&lt;&lt;</span> <span class="n">par</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">vertexc</span><span class="p">;</span>
  <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">vertexc</span><span class="p">;</span>
  <span class="n">HLD</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">dummy</span><span class="o">&gt;</span> <span class="n">hld</span><span class="p">(</span><span class="n">vertexc</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vertexc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">u</span> <span class="o">&gt;&gt;</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">hld</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">hld</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">hld</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">queryc</span><span class="p">;</span>
  <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">queryc</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">queryc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">u</span> <span class="o">&gt;&gt;</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">hld</span><span class="p">.</span><span class="n">query_path</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<header>
<b>Splay Tree + Link-Cut O(NlogN)</b>
</header>
<span></span><span class="k">struct</span> <span class="n">Tree</span> <span class="o">*</span><span class="n">treev</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Tree</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">T</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">constexpr</span> <span class="nf">T</span><span class="p">()</span> <span class="o">:</span> <span class="n">i</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">T</span><span class="p">(</span><span class="kt">int</span> <span class="n">_i</span><span class="p">)</span> <span class="o">:</span> <span class="n">i</span><span class="p">(</span><span class="n">_i</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">operator</span> <span class="kt">int</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span> <span class="p">}</span>               <span class="mi">5021</span>
    <span class="k">explicit</span> <span class="k">operator</span> <span class="nf">bool</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">Tree</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">treev</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">};</span>
  <span class="n">T</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">;</span>
  <span class="cm">/* insert monoid here */</span>
  <span class=" -RegionYellow">T link;</span>
  <span class="n">Tree</span><span class="p">()</span> <span class="p">{</span>
    <span class="cm">/* init monoid here */</span>
    <span class=" -RegionYellow">link = -1;</span>                                      <span class=" -RegionYellow"> 7237</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">using</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">::</span><span class="n">T</span><span class="p">;</span>                                   <span class="mi">5875</span>
<span class="k">constexpr</span> <span class="n">T</span> <span class="n">NIL</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* recalculate the monoid here */</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">propagate</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class=" -RegionYellow"></span>
<span class=" -RegionYellow">  for (T c : t-&gt;c)</span>
<span class=" -RegionYellow">    if (c) c-&gt;link = t-&gt;link;</span>                       <span class=" -RegionYellow"> 8249</span>
  <span class="cm">/* lazily propagate updates here */</span>
<span class="p">}</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">void lazy_reverse(T t) { /* lazily reverse t here */</span>
<span class=" -RegionPink">}</span>
<span class="n">T</span> <span class="nf">splay</span><span class="p">(</span><span class="n">T</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">propagate</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">T</span> <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">NIL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>                             <span class="mi">5925</span>
    <span class="n">propagate</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">ll</span> <span class="n">px</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">;</span>                           <span class=" -RegionPink"> 2795</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">px</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">);</span>                          <span class=" -RegionYellow"> 0722</span>
    <span class="n">T</span> <span class="n">g</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="n">NIL</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* zig */</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">px</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">px</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">px</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>                               <span class="mi">2987</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">px</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">px</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>                          <span class=" -RegionPink"> 7572</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">NIL</span><span class="p">;</span>
      <span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>                                    <span class=" -RegionYellow"> 4253</span>
      <span class="n">update</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">propagate</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
    <span class="n">ll</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">);</span>                           <span class="mi">2867</span>
    <span class="n">T</span> <span class="n">gg</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
    <span class="n">ll</span> <span class="n">ggx</span> <span class="o">=</span> <span class="n">gg</span> <span class="o">&amp;&amp;</span> <span class="n">gg</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">;</span>                   <span class=" -RegionPink"> 8789</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">gg</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">ggx</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">);</span>                <span class=" -RegionYellow"> 8979</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gx</span> <span class="o">==</span> <span class="n">px</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* zig zig */</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>                               <span class="mi">7232</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>                          <span class=" -RegionPink"> 6588</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>                              <span class=" -RegionYellow"> 8474</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* zig zag */</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>                       <span class="mi">3340</span>
      <span class="n">g</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>                              <span class=" -RegionPink"> 6351</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">];</span>                      <span class=" -RegionYellow"> 2638</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
      <span class="n">n</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">gx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>                               <span class="mi">8629</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="n">gg</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">ggx</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>                         <span class=" -RegionPink"> 9629</span>
    <span class="n">n</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">gg</span><span class="p">;</span>
    <span class="n">update</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
    <span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">update</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gg</span><span class="p">)</span> <span class="n">update</span><span class="p">(</span><span class="n">gg</span><span class="p">);</span>                             <span class=" -RegionYellow"> 3586</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">T</span> <span class="n">extreme</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>                              <span class="mi">6751</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>                      <span class=" -RegionPink"> 2290</span>
  <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">T</span> <span class="n">set_child</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">o</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>                                      <span class=" -RegionYellow"> 4115</span>
  <span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
  <span class="n">o</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">NIL</span><span class="p">;</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>                                          <span class="mi">7177</span>
  <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span>                                         <span class="o">%</span><span class="mi">8008</span><span class=" -RegionYellow">%4627</span><span class=" -RegionPink">%1017</span>
<span class="cm">/************* Link-Cut Tree: **************/</span>
<span class="n">T</span> <span class="nf">expose</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">set_child</span><span class="p">(</span><span class="n">splay</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NIL</span><span class="p">);</span>
  <span class="n">T</span> <span class="n">leader</span> <span class="o">=</span> <span class="n">splay</span><span class="p">(</span><span class="n">extreme</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">leader</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="n">NIL</span><span class="p">)</span> <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
  <span class="n">set_child</span><span class="p">(</span><span class="n">splay</span><span class="p">(</span><span class="n">leader</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">expose</span><span class="p">(</span><span class="n">leader</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">splay</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">link</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="n">NIL</span><span class="p">);</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">T</span> <span class="nf">cut</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">expose</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">NIL</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span><span class=" -RegionPink"></span>
<span class=" -RegionPink">void make_root(T t) {</span>
<span class=" -RegionPink">  expose(t);</span>
<span class=" -RegionPink">  lazy_reverse(extreme(splay(t), 0));</span>
<span class=" -RegionPink">}</span>                                              <span class="o">%</span><span class="mi">7295</span><span class=" -RegionPink">%6269</span>





</pre></div>
</body>
</html>
